<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" data-whc_version="26.0">
    <head><link rel="shortcut icon" href="../favicon.ico"/><link rel="icon" href="../favicon.ico"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="description" content="Indicative Optimized Portfolio Value (IOPV) 全称为基金份额参考净值，是由交易所计算的 ETF 实时单位净值的近似值，便于投资者估计 ETF 交易价格是否偏离了其内在价值。ETF 最新价为场内价格，是该 ETF 在二级市场交易的买卖价格。而 IOPV 是这只 ETF 在一级市场的报价，即为 ETF 的净值。IOPV 是 ETF 基金特有，是场内 ETF ..."/><meta name="DC.rights.owner" content="(C) 版权 2025"/><meta name="copyright" content="(C) 版权 2025"/><meta name="generator" content="DITA-OT"/><meta name="DC.type" content="topic"/><meta name="DC.coverage" content=""/><meta name="DC.relation" content="../stream/str_intro.html"/><meta name="prodname" content="DolphinDB"/><meta name="brand" content="DolphinDB"/><meta name="DC.creator" content="DolphinDB"/><meta name="DC.publisher" content="DDB N/A DDB 200"/><meta name="DC.format" content="HTML5"/><meta name="DC.identifier" content="基金份额参考价值-iopv-计算"/><title>基金份额参考价值 IOPV 计算</title><!--  Generated with Oxygen version 26.0, build number 2024012323.  --><meta name="wh-path2root" content="../"/><meta name="wh-toc-id" content="&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;?workdir /tmp/temp20250305183303418/tutorials?&gt;&lt;?workdir-uri file:/tmp/temp20250305183303418/tutorials/?&gt;&lt;?path2project ../?&gt;&lt;?path2project-uri ../?&gt;&lt;?path2rootmap-uri ../?&gt;&lt;topic xmlns:dita-ot=&#34;http://dita-ot.sourceforge.net/ns/201007/dita-ot&#34; xmlns:ditaarch=&#34;http://dita.oasis-open.org/architecture/2005/&#34; class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;基金份额参考价值-iopv-计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:1;1:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:1;1:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;基金份额参考价值 IOPV 计算&lt;/title&gt;&lt;prolog class=&#34;- topic/prolog &#34;&gt;&lt;author class=&#34;- topic/author &#34; xtrc=&#34;author:1;12:17&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;DolphinDB&lt;/author&gt;&lt;publisherinformation class=&#34;- topic/publisher bookmap/publisherinformation &#34; xtrc=&#34;publisherinformation:1;14:31&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt; &lt;person class=&#34;- topic/data bookmap/person &#34; xtrc=&#34;person:1;15:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;DDB&lt;/person&gt; &lt;printlocation class=&#34;- topic/data bookmap/printlocation &#34; xtrc=&#34;printlocation:1;16:28&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;N/A&lt;/printlocation&gt; &lt;published class=&#34;- topic/data bookmap/published &#34; xtrc=&#34;published:1;17:24&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt; &lt;person class=&#34;- topic/data bookmap/person &#34; xtrc=&#34;person:2;18:25&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;DDB&lt;/person&gt; &lt;publishtype class=&#34;- topic/data bookmap/publishtype &#34; value=&#34;HTML&#34; xtrc=&#34;publishtype:1;19:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt; &lt;revisionid class=&#34;- topic/ph bookmap/revisionid &#34; xtrc=&#34;revisionid:1;20:29&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;200&lt;/revisionid&gt; &lt;summary class=&#34;- topic/ph bookmap/summary &#34; xtrc=&#34;summary:1;22:27&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt; &lt;data class=&#34;- topic/data &#34; xtrc=&#34;data:1;23:24&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt; &lt;/published&gt; &lt;data class=&#34;- topic/data &#34; xtrc=&#34;data:2;25:20&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt; &lt;/publisherinformation&gt;&lt;metadata class=&#34;- topic/metadata &#34;&gt;&lt;audience class=&#34;- topic/audience &#34; xtrc=&#34;audience:2;39:20&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt;&lt;audience class=&#34;- topic/audience &#34; xtrc=&#34;audience:1;28:24&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt;&lt;category class=&#34;- topic/category &#34; xtrc=&#34;category:1;29:24&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt;&lt;prodinfo class=&#34;- topic/prodinfo &#34; xtrc=&#34;prodinfo:1;34:23&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt; &lt;prodname class=&#34;- topic/prodname &#34; xtrc=&#34;prodname:1;35:27&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;DolphinDB&lt;/prodname&gt; &lt;brand class=&#34;- topic/brand &#34; xtrc=&#34;brand:1;36:24&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;DolphinDB&lt;/brand&gt; &lt;/prodinfo&gt;&lt;/metadata&gt;&lt;/prolog&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:1;1:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:1;2:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Indicative Optimized Portfolio Value (IOPV) 全称为基金份额参考净值，是由交易所计算的 ETF 实时单位净值的近似值，便于投资者估计 ETF 交易价格是否偏离了其内在价值。ETF 最新价为场内价格，是该 ETF 在二级市场交易的买卖价格。而 IOPV 是这只 ETF 在一级市场的报价，即为 ETF 的净值。IOPV 是 ETF 基金特有，是场内 ETF 的参考值，方便投资者参与套利。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:2;4:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;目前交易所每隔 15 秒公开发布 IOPV 行情。本教程介绍如何使用 DolphinDB 实时计算 ETF 的 IOPV，亦即任何成分股的交易价格发生变化时，重新计算 EFT 的最新 IOPV。这将给量化策略更多多操作空间。 生产环境中实时计算主要有 3 个要求：(1) 能够实现 IOPV 复杂计算；(2) 计算快、交易信号捕捉要灵敏；(3) 具备从行情输入、计算到结果输出完整的实时处理能力。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:3;7:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;本教程中将会学习到:&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:1;9:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:1;9:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;使用&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:1;9:5&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;pivot&lt;/codeph&gt;处理面板数据&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:2;10:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;使用行情回放函数&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:2;10:11&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;replayDS&lt;/codeph&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:3;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;如何进行增量计算&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:4;12:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;流式计算横截面引擎&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:3;12:12&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;CrossSectionalEngine&lt;/codeph&gt;，响应式状态引擎&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:4;12:42&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;ReactiveStateEngine&lt;/codeph&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:5;13:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;函数&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:5;13:5&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;ffill&lt;/codeph&gt;, &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:6;13:14&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;rowSum&lt;/codeph&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:6;14:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;使用消息中间件&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:7;14:10&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;zmq&lt;/codeph&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;related-links class=&#34;- topic/related-links &#34;&gt;&lt;linkpool class=&#34;- topic/linkpool &#34; xtrc=&#34;topicref:72;110:77&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/chap_stream.ditamap&#34;&gt;&lt;link class=&#34;- topic/link &#34; format=&#34;dita&#34; href=&#34;../stream/str_intro.dita&#34; mapclass=&#34;- map/topicref bookmap/chapter &#34; role=&#34;parent&#34; scope=&#34;local&#34; type=&#34;topic&#34; xtrc=&#34;topicref:1;5:59&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/chap_stream.ditamap&#34;&gt;&lt;?ditaot usertext?&gt;&lt;linktext class=&#34;- topic/linktext &#34;&gt;&lt;?ditaot usertext?&gt;流数据&lt;/linktext&gt;&lt;?ditaot usershortdesc?&gt;&lt;desc class=&#34;- topic/desc &#34;&gt;DolphinDB 流数据引擎及流数据计算的基本概念&lt;/desc&gt;&lt;/link&gt;&lt;/linkpool&gt;&lt;/related-links&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;1-计算公式&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:2;17:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:2;17:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;1. 计算公式&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:2;17:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;/&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;11-标准-iopv-计算公式&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:3;18:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:3;18:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;1.1. 标准 IOPV 计算公式&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:3;18:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:4;19:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;计算公式如下：&lt;/p&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/streaming_IOPV/iopv.png&#34; placement=&#34;break&#34; xtrc=&#34;image:1;21:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34; dita-ot:image-width=&#34;862&#34; dita-ot:image-height=&#34;137&#34; dita-ot:horizontal-dpi=&#34;120&#34; dita-ot:vertical-dpi=&#34;120&#34;/&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:2;23:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:7;23:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;P_i：T 日申购赎回清单中第 i 只成分券的实时价格，取净价&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:8;24:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Shares_i：T 日申购赎回清单中第 i 只成分券的数量（单位：手）&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:9;25:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;AI：T 日申购赎回清单中所有成分券在 T 日的应计利息总和&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:10;26:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;ECC：T 日申购赎回清单中的预估现金部分（Estimated Cash Component）&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;12-本教程-iopv-计算公式&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:4;28:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:4;28:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;1.2. 本教程 IOPV 计算公式&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:4;28:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:5;29:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;在无法获得 ETF 基金参考数据源的情况下，我们采用数据模拟构建的方式，因此有以下调整。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:6;31:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:1;31:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;成分券构建&lt;/b&gt;&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:7;33:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;假设每只基金都为 50 只成分券，采用固定和随机两种方式构建成分券。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:8;35:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:2;35:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;计算公式调整&lt;/b&gt;&lt;/p&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/streaming_IOPV/IOPV-adjust.png&#34; placement=&#34;break&#34; xtrc=&#34;image:2;37:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34; dita-ot:image-width=&#34;671&#34; dita-ot:image-height=&#34;132&#34; dita-ot:horizontal-dpi=&#34;120&#34; dita-ot:vertical-dpi=&#34;120&#34;/&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:9;39:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;不将 AI 和 ECC 纳入 IOPV 计算公式中，对计算方法和计算性能影响较小。&lt;/p&gt;&lt;/body&gt;&lt;/topic&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;2-指数构建&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:5;41:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:5;41:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;2. 指数构建&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:5;41:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:10;43:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;固定标的构建用于单只指数的历史和实时 IOPV 计算，随机标的构建用于多只指数的实时 IOPV 计算。&lt;/p&gt;&lt;/body&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;21-固定标的构建&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:6;45:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:6;45:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;2.1. 固定标的构建&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:6;45:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:11;47:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;选取 50 只深市股票作为成分券，并为每只成分券设置一个随机仓位，然后构建一个 “字典” 类型的指数。&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; outputclass=&#34;python&#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:1;49:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;symbols = `300073`300363`300373`300474`300682`300769`301029`300390`300957`300763`300979`300919`300037`300832`300866`300896`300751`300223`300676`300274`300413`300496`300661`300782`300142`300759`300595`300285`300146`300207`300316`300454`300529`300699`300628`300760`300601`300450`300433`300408`300347`300124`300122`300059`300033`300015`300014`300012`300003`300750 positions = rand(76339..145256, 50) portfolio = dict(symbols, positions)&lt;/codeblock&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;22-随机标的构建&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:7;55:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:7;55:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;2.2. 随机标的构建&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:7;55:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:12;57:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:8;57:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;getBasketData()&lt;/codeph&gt; 函数会构建100只指数，在深市股票逐笔成交中随机选取50只股票作为成分股，并设置随机仓位。&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; outputclass=&#34;python&#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:2;59:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;def getBasketData(allSymbol, n){ return loop(x-&amp;gt;table(take(x, 50) as BasketID, rand(allSymbol, 50) as SecurityID, rand(76339..145256, 50) as Vol), 1..n).unionAll(false) } trade = loadTable(&#34;dfs://LEVEL2_SZ&#34;,&#34;Trade&#34;) allSyms = select count(*) from trade where date(tradetime) = 2020.01.02 group by SecurityID basket = getBasketData(allSyms.SecurityID, 100)&lt;/codeblock&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;23-逐笔成交数据表结构&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:8;69:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:8;69:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;2.3. 逐笔成交数据表结构&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:8;69:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:13;71:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;采用深交所 Level2 逐笔成交进行 IOPV 计算，表结构如下：&lt;/p&gt;&lt;table class=&#34;- topic/table &#34; xtrc=&#34;table:1;73:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;tgroup class=&#34;- topic/tgroup &#34; cols=&#34;4&#34; xtrc=&#34;tgroup:1;73:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col1&#34; colnum=&#34;1&#34; xtrc=&#34;colspec:1;73:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col2&#34; colnum=&#34;2&#34; xtrc=&#34;colspec:2;73:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col3&#34; colnum=&#34;3&#34; xtrc=&#34;colspec:3;73:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col4&#34; colnum=&#34;4&#34; xtrc=&#34;colspec:4;73:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;/&gt;&lt;thead class=&#34;- topic/thead &#34; xtrc=&#34;thead:1;73:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:1;73:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:1;73:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;name&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:2;73:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;typeString&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:3;73:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;typeInt&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:4;73:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;comment&lt;/entry&gt;&lt;/row&gt;&lt;/thead&gt;&lt;tbody class=&#34;- topic/tbody &#34; xtrc=&#34;tbody:1;75:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:2;75:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:5;75:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;tradedate&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:6;75:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;DATE&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:7;75:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;6&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:8;75:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:3;76:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:9;76:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;OrigTime&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:10;76:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;TIMESTAMP&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:11;76:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;12&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:12;76:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:4;77:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:13;77:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;SendTime&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:14;77:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;TIMESTAMP&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:15;77:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;12&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:16;77:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:5;78:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:17;78:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;recvtime&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:18;78:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;TIMESTAMP&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:19;78:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;12&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:20;78:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:6;79:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;6&#34; xtrc=&#34;entry:21;79:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;dbtime&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;6&#34; xtrc=&#34;entry:22;79:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;TIMESTAMP&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;6&#34; xtrc=&#34;entry:23;79:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;12&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;6&#34; xtrc=&#34;entry:24;79:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:7;80:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;7&#34; xtrc=&#34;entry:25;80:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;ChannelNo&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;7&#34; xtrc=&#34;entry:26;80:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;INT&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;7&#34; xtrc=&#34;entry:27;80:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;4&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;7&#34; xtrc=&#34;entry:28;80:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:8;81:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;8&#34; xtrc=&#34;entry:29;81:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;MDStreamID&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;8&#34; xtrc=&#34;entry:30;81:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;SYMBOL&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;8&#34; xtrc=&#34;entry:31;81:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;17&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;8&#34; xtrc=&#34;entry:32;81:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:9;82:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;9&#34; xtrc=&#34;entry:33;82:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;ApplSeqNum&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;9&#34; xtrc=&#34;entry:34;82:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;LONG&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;9&#34; xtrc=&#34;entry:35;82:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;5&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;9&#34; xtrc=&#34;entry:36;82:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:10;83:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;10&#34; xtrc=&#34;entry:37;83:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;SecurityID&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;10&#34; xtrc=&#34;entry:38;83:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;SYMBOL&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;10&#34; xtrc=&#34;entry:39;83:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;17&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;10&#34; xtrc=&#34;entry:40;83:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:11;84:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;11&#34; xtrc=&#34;entry:41;84:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;SecurityIDSource&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;11&#34; xtrc=&#34;entry:42;84:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;SYMBOL&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;11&#34; xtrc=&#34;entry:43;84:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;17&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;11&#34; xtrc=&#34;entry:44;84:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:12;85:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;12&#34; xtrc=&#34;entry:45;85:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;BidApplSeqNum&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;12&#34; xtrc=&#34;entry:46;85:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;INT&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;12&#34; xtrc=&#34;entry:47;85:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;4&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;12&#34; xtrc=&#34;entry:48;85:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:13;86:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;13&#34; xtrc=&#34;entry:49;86:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;OfferApplSeqNum&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;13&#34; xtrc=&#34;entry:50;86:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;INT&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;13&#34; xtrc=&#34;entry:51;86:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;4&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;13&#34; xtrc=&#34;entry:52;86:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:14;87:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;14&#34; xtrc=&#34;entry:53;87:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Price&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;14&#34; xtrc=&#34;entry:54;87:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;DOUBLE&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;14&#34; xtrc=&#34;entry:55;87:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;16&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;14&#34; xtrc=&#34;entry:56;87:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:15;88:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;15&#34; xtrc=&#34;entry:57;88:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;TradeQty&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;15&#34; xtrc=&#34;entry:58;88:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;INT&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;15&#34; xtrc=&#34;entry:59;88:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;4&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;15&#34; xtrc=&#34;entry:60;88:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:16;89:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;16&#34; xtrc=&#34;entry:61;89:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;ExecType&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;16&#34; xtrc=&#34;entry:62;89:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;SYMBOL&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;16&#34; xtrc=&#34;entry:63;89:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;17&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;16&#34; xtrc=&#34;entry:64;89:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:17;90:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;17&#34; xtrc=&#34;entry:65;90:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;tradetime&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;17&#34; xtrc=&#34;entry:66;90:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;TIMESTAMP&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;17&#34; xtrc=&#34;entry:67;90:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;12&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;17&#34; xtrc=&#34;entry:68;90:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt; &lt;/entry&gt;&lt;/row&gt;&lt;/tbody&gt;&lt;/tgroup&gt;&lt;/table&gt;&lt;/body&gt;&lt;/topic&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;3-历史-iopv-计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:9;92:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:9;92:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;3. 历史 IOPV 计算&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:9;92:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;/&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;31-传统-iopv-计算方法&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:10;94:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:10;94:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;3.1. 传统 IOPV 计算方法&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:10;94:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:14;96:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;基于历史逐笔成交计算更细颗粒度的 IOPV，传统计算方法如下：&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:15;98:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;将50只成分券的所有逐笔数据合并，并按照时间戳排序。计算时按时间戳遍历股票数据，计算每个时间戳 50 只股票的总价值，作为当前时间戳的 IOPV。若某一时间戳下，存在股票数据缺失，则用前一时间戳下该股票的数据进行填充。在程序中需要分别记录50只股票最近一个时间戳的价格并随时更新。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:16;101:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;传统计算方法有几点不足：&lt;/p&gt;&lt;ol class=&#34;- topic/ol &#34; xtrc=&#34;ol:1;102:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:11;102:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;传统方法采用循环的方式遍历计算，导致性能不高。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:12;103:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;会存在不同股票相同时间戳的数据，需要代码判断读到最新时间戳才能触发汇总计算逻辑，导致代码复杂。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:13;104:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;需要把前一股票价值手工存储在一个变量里，并随时更新这个变量，导致代码复杂。&lt;/li&gt;&lt;/ol&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:17;106:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;因此，基于逐笔成交的传统 IOPV 计算方法会有耗时长和代码复杂两个缺点。&lt;/p&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;32-dolphindb-数据面板计算方法&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:11;108:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:11;108:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;3.2. DolphinDB 数据面板计算方法&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:11;108:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:18;110:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;在 DolphinDB 中利用 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:9;110:17&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;pivot by&lt;/codeph&gt; 生成一个数据面板（矩阵），再对矩阵进行向量化运算可以提高计算速度，同时代码更为简洁。&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; outputclass=&#34;python&#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:3;112:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;timeSeriesValue = select tradetime, SecurityID, price * portfolio[SecurityID]/1000 as constituentValue from loadTable(&#34;dfs://LEVEL2_SZ&#34;,&#34;Trade&#34;) where SecurityID in portfolio.keys(), tradedate = 2020.12.01, price &amp;gt; 0 iopvHist = select rowSum(ffill(constituentValue)) as IOPV from timeSeriesValue pivot by tradetime, SecurityID&lt;/codeblock&gt;&lt;ol class=&#34;- topic/ol &#34; xtrc=&#34;ol:2;117:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:14;117:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;计算股票价值&lt;/li&gt;&lt;/ol&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:19;119:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;timeSeriesValue 得到每个时间戳下的所有成分券价值，本次代码示例计算深交所 2021.12.01 这一日的逐笔成交的历史 IOPV，其中 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:10;119:77&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;loadTable(&#34;dfs://LEVEL2_SZ&#34;,&#34;Trade&#34;)&lt;/codeph&gt; 使用的是逐笔成交表。&lt;/p&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/streaming_IOPV/timeseriesvalue.png&#34; placement=&#34;break&#34; xtrc=&#34;image:3;121:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34; dita-ot:image-width=&#34;313&#34; dita-ot:image-height=&#34;497&#34; dita-ot:horizontal-dpi=&#34;120&#34; dita-ot:vertical-dpi=&#34;120&#34;/&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:20;123:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;上图中 constituentValue 是每一时间戳时当前股票仓位的价值。&lt;/p&gt;&lt;ol class=&#34;- topic/ol &#34; xtrc=&#34;ol:3;125:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:15;125:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;面板数据计算 IOPV&lt;/li&gt;&lt;/ol&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:21;127:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;利用 DolphinDB 中的 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:11;127:17&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;pivot by&lt;/codeph&gt; 数据透视功能生成一个面板数据，横轴是50只成分券，纵轴是时间戳，数据点代表每只成分券在一个时间戳上的价值。&lt;/p&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/streaming_IOPV/iopv-pivot.png&#34; placement=&#34;break&#34; xtrc=&#34;image:4;129:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34; dita-ot:image-width=&#34;802&#34; dita-ot:image-height=&#34;355&#34; dita-ot:horizontal-dpi=&#34;120&#34; dita-ot:vertical-dpi=&#34;120&#34;/&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:22;132:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;对面板数据的纵轴（时间序列）的空置填充最近前一笔有效价值，再对横轴（成分券）汇总即可得到每个时间戳上的 IOPV 结果。&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:3;134:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:16;134:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:12;134:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;ffill&lt;/codeph&gt;会找到前一笔最近的非空值，相当于传统方法取前一股票价值。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:17;135:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:13;135:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;rowSum&lt;/codeph&gt;对横向行数据汇总，即把所有成分券的价值汇总得出 IOPV。&lt;/li&gt;&lt;/ul&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:23;137:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;在 DolphinDB 中使用一行代码就能完成传统 IOPV 计算步骤3中的复杂逻辑；同时，DolphinDB 是向量计算，能够充分利用多线程完成高效运算。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:24;139:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;面板数据有以下优点，参考阅读 &lt;xref class=&#34;- topic/xref &#34; format=&#34;html&#34; href=&#34;https://cn.bing.com/search?q=Baltagi%2C%20Econometric%20Analysis%20of%20Panel%20Data&amp;amp;qs=n&amp;amp;form=QBRE&amp;amp;=%25eManage%20Your%20Search%20History%25E&amp;amp;sp=-1&amp;amp;pq=baltagi%2C%20econometric%20analysis%20of%20panel%20data&amp;amp;sc=1-43&amp;amp;sk=&amp;amp;cvid=E6E66A3E75864576AAA92648BF01B5D6&amp;amp;ghsh=0&amp;amp;ghacc=0&amp;amp;ghpl=&#34; scope=&#34;external&#34; xtrc=&#34;xref:1;139:16&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;?ditaot usertext?&gt;Baltagi, Econometric Analysis of Panel Data&lt;/xref&gt; Chapter 1 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:14;139:351&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;1.2 Why should we use Panel Data? The Benefits and Limitations&lt;/codeph&gt;:&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:25;141:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:3;141:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Benefits&lt;/b&gt;&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:4;143:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:18;143:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Controlling for individual heterogeneity.&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:19;144:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Panel data give more informative data, more variablility, less collinearity among the variables, more degrees of freedom and more effciency.&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:20;145:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Panel data are better able to study the dymanics of adjustment.&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:21;146:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Panel data are better able to identify and measure effects that are simply not detectable in pure cross-section or pure time-series data.&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:22;147:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Panel data models allow us to construct and test more complicated behavioral models than purely cross-section or time-series data.&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:23;148:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Micro panel data gathered on individuals, firms and households may be more accurately measured than similar variables measured at the macro level.&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:24;149:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Macro panel data on the other hand have a longer time series and unlike the problem of nonstandard distributions typical of units roots tests in time-series analysis.&lt;/li&gt;&lt;/ul&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:26;151:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:4;151:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Limitations&lt;/b&gt;&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:5;153:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:25;153:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Design and data collection problems.&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:26;154:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Distortions of measurement errors.&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:27;155:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Selectivity problems.&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:28;156:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Short time-series dimensions.&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:29;157:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;Cross-section dependence.&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/topic&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;4-单只-etf-实时计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:12;160:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:12;160:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;4. 单只 ETF 实时计算&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:12;160:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:27;162:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;案例代码展示从[数据接入]-&amp;gt;[实时计算]-&amp;gt;[下游系统消费]一个完整的流数据处理流程。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:28;164:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;只要通过3段代码即可实现完整的业务逻辑：&lt;/p&gt;&lt;/body&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;41-数据接入-replayds历史行情回放&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:13;166:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:13;166:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;4.1. [数据接入] replayDS：历史行情回放&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:13;166:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:29;168:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;通过历史行情回放的形式模拟实时行情。使用 DolphinDB 内置的 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:15;168:36&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;replayDS&lt;/codeph&gt; 函数能够轻松实现数据回放，实际投研和生产中还可以使用 replayDS 多表联合回放成交、订单和快照行情。&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; outputclass=&#34;python&#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:4;170:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;t = streamTable(100:0, `SecurityID`tradedate`tradetime`price,[SYMBOL, DATE,TIMESTAMP,DOUBLE]) enableTableShareAndPersistence(table=t, tableName=`TradeStreamData, cacheSize=1000000) rds = replayDS(&amp;lt;select SecurityID, tradedate, tradetime , price from loadTable(&#34;dfs://LEVEL2_SZ&#34;,&#34;Trade&#34;) where tradedate = 2020.12.01, price&amp;gt;0 &amp;gt;, `tradedate, `tradetime, cutPoints(09:30:00.000..16:00:00.000, 60)); submitJob(&#34;replay_order&#34;, &#34;replay_trades_stream&#34;, replay, rds, `TradeStreamData, `tradedate, `tradetime, 1000000, true, 4)&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:30;176:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;上段代码回放了 2020.12.01 这一天的逐笔成交数据，并把回放数据写入到流数据表 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:16;176:45&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;TradeStreamData&lt;/codeph&gt; 中。&lt;/p&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;42-实时计算-iopv-横截面计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:14;178:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:14;178:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;4.2. [实时计算] IOPV 横截面计算&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:14;178:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:31;180:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;使用横截面计算引擎 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:17;180:11&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;CrossSectionalEngine&lt;/codeph&gt; 计算 IOPV&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; outputclass=&#34;python&#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:5;182:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;share streamTable(1000:0, `tradetime`tradedate`IOPV, [TIMESTAMP,DATE,DOUBLE]) as IOPVStreamResult IOPV_engine = createCrossSectionalEngine(name=&#34;IOPV_calculator&#34;, metrics=[&amp;lt;last(tradedate)&amp;gt;, &amp;lt;sum(ffill(price) * portfolio[SecurityID]/1000)&amp;gt;], dummyTable=TradeStreamData, outputTable=IOPVStreamResult, keyColumn=`SecurityID, triggeringPattern='perRow', timeColumn=`tradetime, useSystemTime=false) setStreamTableFilterColumn(TradeStreamData, `SecurityID) subscribeTable(tableName=&#34;TradeStreamData&#34;, actionName=&#34;trade_subscribe&#34;, offset=0, handler=append!{IOPV_engine}, msgAsTable=true, batchSize=10000, throttle=1, hash=0, filter=portfolio.keys());&lt;/codeblock&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:6;189:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:30;189:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;上段代码首先创建了流表 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:18;189:16&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;IOPVStreamResult&lt;/codeph&gt;，将在这个流表中存储 IOPV 计算结果；&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:31;190:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:19;190:4&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;IOPV_engine&lt;/codeph&gt; 行实现了 IOPV 的业务逻辑，由于 IOPV 也是一个横截面计算，这里使用了横截面引擎；&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:32;191:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;最后 subscribeTable 的时候执行 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:20;191:28&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;IOPV_engine&lt;/codeph&gt; 计算引擎，只读取成分券 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:21;191:58&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;portfolio.key()&lt;/codeph&gt; 的行情数据，这种数据过滤处理可以提高执行速度。&lt;/li&gt;&lt;/ul&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:32;193:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:5;193:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;横截面计算逻辑&lt;/b&gt;：&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:7;195:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:33;195:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;横截面计算 (&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:22;195:10&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;createCrossSectionalEngine&lt;/codeph&gt;)，顾名思义就是一个时间戳（时间截面）上的计算，也可以表述为多只股票的数据在同一时间截面 (同一时间戳）上的计算。在这个例子中，就是一个时间截面（时间戳）上需要汇总（sum）所有的股票价值得到净值。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:34;196:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;在实时 IOPV 计算时，只要收到了一只成分券的最新价格，就计算一次 IOPV，所以设置了 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:23;196:49&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;triggeringPattern='perRow'&lt;/codeph&gt;；代表只要收到一笔新的逐笔成交行情，就会触发一次 IOPV 计算。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:35;197:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:24;197:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;metrics=[&amp;lt;last(tradedate)&amp;gt;, &amp;lt;sum(ffill(price) * portfolio[SecurityID]/1000)&amp;gt;]&lt;/codeph&gt; 是 IOPV 计算的业务逻辑。&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;43-下游系统消费通过-zmq-消费计算结果&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:15;199:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:15;199:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;4.3. [下游系统消费]通过 ZMQ 消费计算结果&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:15;199:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:6;200:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;try{ formatter = zmq::createJSONFormatter() socket = zmq::socket(&#34;ZMQ_PUB&#34;, formatter) zmq::bind(socket, &#34;tcp://*:20414&#34;) }catch(ex){} subscribeTable(tableName=&#34;IOPVStreamResult&#34;, actionName=&#34;IOPV_mq_read&#34;, offset=0, handler=zmq::send{socket}, msgAsTable=true)&lt;/codeblock&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:8;210:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:36;210:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;在下游系统中订阅数据时通过 ZMQ handler 接收数据&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:37;211:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;下游系统根据实时 IOPV 创建交易策略（本教程未包含策略实现&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:38;212:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;参考&lt;xref class=&#34;- topic/xref &#34; format=&#34;md&#34; href=&#34;https://gitee.com/dolphindb/DolphinDBPlugin/blob/release200/zmq/README.md&#34; scope=&#34;external&#34; xtrc=&#34;xref:2;212:5&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;?ditaot usertext?&gt;DolphinDB zmq Plugin&lt;/xref&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/topic&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;5-多只-etf-实时增量计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:16;214:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:16;214:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;5. 多只 ETF 实时增量计算&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:16;214:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:33;215:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;计算全市场500多只 ETF IOPV 时，如果使用实时计算（单只-etf-实时计算）的方法，由于每次收到新的逐笔成交就要做一次汇总，计算量会非常庞大，因此不是最优方案。通过 DolphinDB 响应式状态引擎增量计算，可以大幅降低算法计算步骤，计算更加高效。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:34;217:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;核心代码如下：&lt;/p&gt;&lt;/body&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;51-过滤价格不变数据&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:17;219:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:17;219:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;5.1. 过滤价格不变数据&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:17;219:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:35;221:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;基于逐笔数据，两个相邻行情中有大量最新价一致的数据，首先可以过滤这些数据，在增量计算中他们不对净值结果产生影响。&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; outputclass=&#34;python&#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:7;223:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;metricsFuc = [ &amp;lt;tradetime&amp;gt;, &amp;lt;Price&amp;gt;] createReactiveStateEngine(name=&#34;tradeProcessPriceChange&#34;, metrics=metricsFuc, dummyTable=tradeOriginalStream, outputTable=tradeOriginalStream, keyColumn=`SecurityID, filter=&amp;lt;deltas(Price) != 0&amp;gt;, keepOrder=true)&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:36;229:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;上段代码只会把 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:25;229:9&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;deltas(Price) != 0&lt;/codeph&gt;，即价格发生了变化的股票用于后续的估值计算。&lt;/p&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;52-增量算子计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:18;231:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:18;231:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;5.2. 增量算子计算&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:18;231:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:37;233:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;只计算变化量.&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; outputclass=&#34;python&#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:8;234:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;metricsProcess = [ &amp;lt;tradetime&amp;gt;, &amp;lt;deltas(Price*Vol/1000)&amp;gt;] createReactiveStateEngine(name=&#34;tradeProcessIOPVChange&#34;, metrics=metricsProcess, dummyTable=tradeProcessDummy, outputTable=getStreamEngine(`IOPVResult), keyColumn=`BasketID`SecurityID, keepOrder=true)&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:38;240:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;上端代码中通过元代码 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:26;240:12&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&amp;lt;deltas(Price*Vol/1000)&amp;gt;&lt;/codeph&gt; 计算 delta 变化量，即增量算子。&lt;/p&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;53-增量计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:19;242:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:19;242:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;5.3. 增量计算&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:19;242:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:39;244:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;DolphinDB 内置的累计聚合函数 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:27;244:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;cumsum&lt;/codeph&gt; 实现了增量计算。&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:9;245:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;metricsResult = [ &amp;lt;tradetime&amp;gt;, &amp;lt;cumsum(deltaValue)&amp;gt;] createReactiveStateEngine(name=&#34;IOPVResult&#34;, metrics=metricsResult, dummyTable=tradeResultDummy, outputTable=IOPVResult, keyColumn=`BasketID, keepOrder=true)&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:40;252:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;响应式状态引擎的增量计算逻辑如下：&lt;/p&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/streaming_IOPV/incrumental_computing.png&#34; placement=&#34;break&#34; xtrc=&#34;image:5;254:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34; dita-ot:image-width=&#34;1072&#34; dita-ot:image-height=&#34;606&#34; dita-ot:horizontal-dpi=&#34;120&#34; dita-ot:vertical-dpi=&#34;120&#34;/&gt;&lt;ol class=&#34;- topic/ol &#34; xtrc=&#34;ol:4;256:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:39;256:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;我们先简单创建一张估值表，包含 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:28;256:20&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&#34;securityID&#34;,&#34;price&#34;,&#34;vol&#34;,&#34;value&#34;&lt;/codeph&gt; 四个字段，其中 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:29;256:65&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;value=price*vol&lt;/codeph&gt;。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:40;257:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;计算 IOPV*1000，只需要把10只票的价值相加即可。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:41;258:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:30;258:4&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;securityID=1&lt;/codeph&gt; 这只票的价格发生了变化，变成了 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:31;258:35&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;15.41&lt;/codeph&gt;。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:42;259:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;只需要计算变化量 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:32;259:13&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;deltas= (new price – last price) * vol&lt;/codeph&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:43;260:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;增量计算净值 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:33;260:11&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;New IOPV*1000= Last IOPV * 1000 + deltas&lt;/codeph&gt;，这种算法的时间复杂度最低，不再需要 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:34;260:72&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;rowSum&lt;/codeph&gt; 计算。非增量算法如图所示计算量较大。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:44;261:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;在示例中有段 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:35;261:11&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&amp;lt;filter=&amp;lt;deltas(Price) != 0&amp;gt;&lt;/codeph&gt; 过滤器代码，如果价格没有变化，则净值不会变化，不需要计算。相当于实现了 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:36;261:78&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;ffill&lt;/codeph&gt;。&lt;/li&gt;&lt;/ol&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:41;263:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:6;263:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;注意&lt;/b&gt;：采用响应式式状态引擎 ReactiveStateEngine 的主要作用是需要记录计算过程中的状态。如图公式 deltas= (new price – last price) * vol, 该公式中的 &lt;i class=&#34;+ topic/ph hi-d/i &#34; xtrc=&#34;i:1;263:109&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;price&lt;/i&gt; 和 &lt;i class=&#34;+ topic/ph hi-d/i &#34; xtrc=&#34;i:2;263:119&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;vol&lt;/i&gt; 只能是 securitID=1 的价格和持仓量，也称为需要记录 “状态”。&lt;/p&gt;&lt;/body&gt;&lt;/topic&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;6-回顾&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:20;265:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:20;265:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;6. 回顾&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:20;265:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:42;267:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;本教程展示了基于 DolphinDB 的多种 IOPV 计算方法。&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:9;269:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:45;269:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;历史 IOPV 计算: 学习了使用 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:37;269:22&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;piovt&lt;/codeph&gt; 进行面板数据处理，&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:38;269:39&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;pivot by&lt;/codeph&gt; 是 DolphinDB 中极为常用的数据处理方式，与 python 中的 DataFrame 极为类似，使用 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:39;269:105&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;pivot by&lt;/codeph&gt; 可以数据处理简单和高效。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:46;270:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;单只 ETF 实时计算: 学习了横截面计算引擎和实时数据[数据接入]-&amp;gt;[实时计算]-&amp;gt;[下游系统消费]完整的处理流程。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:47;271:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;多只 ETF 实时计算: 学习了通过响应式状态引擎实现增量计算，相较于 “单只指数实时计算”，其计算效率更高。&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;7-源代码&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:21;273:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:21;273:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;7. 源代码&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:21;273:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;ol class=&#34;- topic/ol &#34; xtrc=&#34;ol:5;274:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:48;274:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;xref class=&#34;- topic/xref &#34; format=&#34;dos&#34; href=&#34;script/streaming_IOPV/1.%20IOPV_hist.dos&#34; xtrc=&#34;xref:3;274:5&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;?ditaot usertext?&gt;历史 IOPV 计算&lt;/xref&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:49;275:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;xref class=&#34;- topic/xref &#34; format=&#34;dos&#34; href=&#34;script/streaming_IOPV/2.%20IOPV_realtime_single.dos&#34; xtrc=&#34;xref:4;275:5&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;?ditaot usertext?&gt;单只 ETF 实时计算 IOPV&lt;/xref&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:50;276:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;xref class=&#34;- topic/xref &#34; format=&#34;dos&#34; href=&#34;script/streaming_IOPV/3.%20IOPV_realtime_mult.dos&#34; xtrc=&#34;xref:5;276:5&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/streaming_IOPV.md&#34;&gt;&lt;?ditaot usertext?&gt;多只 ETF 实时增量计算 IOPV&lt;/xref&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/body&gt;&lt;/topic&gt;&lt;/topic&gt;"/><meta name="wh-source-relpath" content="tutorials/streaming_IOPV.md"/><meta name="wh-out-relpath" content="tutorials/streaming_IOPV.html"/>

    <link rel="stylesheet" type="text/css" href="../oxygen-webhelp/app/commons.css?buildId=2024012323"/>
    <link rel="stylesheet" type="text/css" href="../oxygen-webhelp/app/topic.css?buildId=2024012323"/>

    <script src="../oxygen-webhelp/app/options/properties.js?buildId=20250305183303"></script>
    <script src="../oxygen-webhelp/app/localization/strings.js?buildId=2024012323"></script>
    <script src="../oxygen-webhelp/app/search/index/keywords.js?buildId=20250305183303"></script>
    <script defer="defer" src="../oxygen-webhelp/app/commons.js?buildId=2024012323"></script>
    <script defer="defer" src="../oxygen-webhelp/app/topic.js?buildId=2024012323"></script>
<link rel="stylesheet" type="text/css" href="../oxygen-webhelp/template/styles.css?buildId=2024012323"/><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script></head>

    <body id="基金份额参考价值-iopv-计算" class="wh_topic_page frmBody">
        <a href="#wh_topic_body" class="sr-only sr-only-focusable">
            跳转到主要内容
        </a>
        
        
        
        
        <header class="navbar navbar-default wh_header">
    <div class="container-fluid">
        <div xmlns:whc="http://www.oxygenxml.com/webhelp/components" class="wh_header_flex_container navbar-nav navbar-expand-md navbar-dark">
            <div class="wh_logo_and_publication_title_container">
                <div class="wh_logo_and_publication_title">
                    
                    <a href="https://docs.dolphindb.cn/zh/index.html" class=" wh_logo d-none d-sm-block "><img src="../logo.png" alt="  DolphinDB 文档中心  "/></a>
                    <div class=" wh_publication_title "><a href="../index.html"><span class="booktitle">  <span class="ph mainbooktitle">DolphinDB 文档中心</span>  </span></a></div>
                    
                </div>
                
                
            </div>

            <div class="wh_top_menu_and_indexterms_link collapse navbar-collapse" id="wh_top_menu_and_indexterms_link">
                
                
                
                
            </div>
        <div class=" wh_search_input navbar-form wh_topic_page_search search " role="form">
            
            
            
            <form id="searchForm" method="get" role="search" action="../search.html"><div><input type="search" placeholder="搜索 " class="wh_search_textfield" id="textToSearch" name="searchQuery" aria-label="搜索查询" required="required"/><button type="submit" class="wh_search_button" aria-label="搜索"><span class="search_input_text">搜索</span></button></div></form>
            
            <script src="/vendors/react/umd/react.production.min.js" defer="defer"></script>
<script src="/vendors/react-dom/umd/react-dom.production.min.js" defer="defer"></script>
<script src="/vendors/dayjs/dayjs.min.js" defer="defer"></script>
<script src="/vendors/antd/dist/antd.min.js" defer="defer"></script>
<script src="/vendors/@ant-design/icons/dist/index.umd.min.js" defer="defer"></script>
<script src="/zh/index.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" defer="defer"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer="defer"><!--


--></script>
<script defer="defer"><!--

// 从主页重定向
const currentUrl = window.location.href;

// 判断当前URL是否包含index.html并且路径最后部分是index.html
if (currentUrl.endsWith('index.html')) {
    // 处理根目录下的index.html跳转
    const baseUrl = currentUrl.split('/index.html')[0]; // 获取index.html之前的部分
    const redirectUrl = `${baseUrl}/about/ddb_intro.html`; // 构建跳转路径
    window.location.href = redirectUrl; // 执行跳转
}

--></script>
            
        </div></div>
    </div>
</header>
        
        
         
        
        
        
        <div class="container-fluid" id="wh_topic_container">
            <div class="row">

                <nav class="wh_tools d-print-none navbar-expand-md" aria-label="Tools">
                    
                    <div data-tooltip-position="bottom" class=" wh_breadcrumb "><ol class="d-print-none"><li><span class="home"><a href="../index.html"><span>主页</span></a></span></li><li><div class="topicref" data-id="chap7_tutorials_streaming"><div class="title"><a href="../stream/str_intro.html"><span class="keyword label">流数据</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 流数据引擎及流数据计算的基本概念</p></div></div></div></li><li><div class="topicref"><div class="title"><a href="../tutorials/streaming_auto_sub.html">金融场景应用案例</a></div></div></li><li class="active"><div class="topicref" data-id="基金份额参考价值-iopv-计算"><div class="title"><a href="../tutorials/streaming_IOPV.html">基金份额参考价值 IOPV 计算</a></div></div></li></ol></div>
                    
                    
                    
                    <div class="wh_right_tools">
                        <button class="wh_hide_highlight" aria-label="切换搜索突出显示" title="切换搜索突出显示"></button>
                        <button class="webhelp_expand_collapse_sections" data-next-state="collapsed" aria-label="折叠截面" title="折叠截面"></button>
                        
                        
                        
                        
                        <div class=" wh_print_link print d-none d-md-inline-block "><button onClick="window.print()" title="打印此页" aria-label="打印此页"></button></div>
                        
                        <button type="button" id="wh_toc_button" class="custom-toggler navbar-toggler collapsed wh_toggle_button navbar-light" aria-expanded="false" aria-label="Toggle publishing table of content" aria-controls="wh_publication_toc">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </div>
                    
                </nav>
            </div>
            
            
            
            
            <div class="wh_content_area">
                <div class="row">
                    
                        <nav id="wh_publication_toc" class="col-lg-3 col-md-3 col-sm-12 d-md-block d-none d-print-none" aria-label="Table of Contents Container">
                            <div id="wh_publication_toc_content">
		                        
                            	<div class=" wh_publication_toc " data-tooltip-position="right"><span class="expand-button-action-labels"><span id="button-expand-action" role="button" aria-label="Expand"></span><span id="button-collapse-action" role="button" aria-label="Collapse"></span><span id="button-pending-action" role="button" aria-label="Pending"></span></span><ul role="tree" aria-label="Table of Contents"><li role="treeitem"><div data-tocid="ddb_intro-d9713e87" class="topicref" data-id="ddb_intro" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../about/ddb_intro.html" id="ddb_intro-d9713e87-link">关于DolphinDB</a></div></div></li><li role="treeitem"><div data-tocid="chap1_getstarted-d9713e136" class="topicref" data-id="chap1_getstarted" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../getstarted/chap1_getstarted.html" id="chap1_getstarted-d9713e136-link">快速上手</a><div class="wh-tooltip"><p class="shortdesc">如何快速部署 DolphinDB、建库建表、写入和查询数据</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="sectionddb_deployment-d9713e189" class="topicref" data-id="sectionddb_deployment" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action sectionddb_deployment-d9713e189-link" class="wh-expand-btn"></span><div class="title"><a href="../deploy/deploy_intro.html" id="sectionddb_deployment-d9713e189-link"><span class="keyword label">部署</span></a><div class="wh-tooltip"><p class="shortdesc">如何在不同的场景中部署 DolphinDB</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="new_chap_database_manage_new_chap_dbmanage_landing_page-d9713e2259" class="topicref" data-id="new_chap_database_manage_new_chap_dbmanage_landing_page" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action new_chap_database_manage_new_chap_dbmanage_landing_page-d9713e2259-link" class="wh-expand-btn"></span><div class="title"><a href="../db_distr_comp/cfg/db_intro.html" id="new_chap_database_manage_new_chap_dbmanage_landing_page-d9713e2259-link"><span class="keyword label">数据库</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 数据库的基本概念</p></div></div></div></li><li role="treeitem" aria-expanded="true"><div data-tocid="chap7_tutorials_streaming-d9713e3760" class="topicref" data-id="chap7_tutorials_streaming" data-state="expanded"><span role="button" tabindex="0" aria-labelledby="button-collapse-action chap7_tutorials_streaming-d9713e3760-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_intro.html" id="chap7_tutorials_streaming-d9713e3760-link"><span class="keyword label">流数据</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 流数据引擎及流数据计算的基本概念</p></div></div></div><ul role="group" class="navbar-nav nav-list"><li role="treeitem" aria-expanded="false"><div data-tocid="streamfunctions-d9713e3813" class="topicref" data-id="streamfunctions" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action streamfunctions-d9713e3813-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_funcs.html" id="streamfunctions-d9713e3813-link">功能简介</a></div></div></li><li role="treeitem"><div data-tocid="入门示例-01实时计算买卖价差-d9713e4044" class="topicref" data-id="入门示例-01实时计算买卖价差" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/try_example1.html" id="入门示例-01实时计算买卖价差-d9713e4044-link">入门示例</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="内置流式计算算子-d9713e4090" class="topicref" data-id="内置流式计算算子" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action 内置流式计算算子-d9713e4090-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_operator.html" id="内置流式计算算子-d9713e4090-link"><span class="keyword label">流式计算算子</span></a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="streamingEngineTopic-d9713e4229" class="topicref" data-id="streamingEngineTopic" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action streamingEngineTopic-d9713e4229-link" class="wh-expand-btn"></span><div class="title"><a href="../funcs/themes/streamingEngine.html" id="streamingEngineTopic-d9713e4229-link"><span class="keyword label">流计算引擎</span></a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap7_tutorials_streaming-d9713e4506" class="topicref" data-id="chap7_tutorials_streaming" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap7_tutorials_streaming-d9713e4506-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_join_engine.html" id="chap7_tutorials_streaming-d9713e4506-link"><span class="keyword label">内置多数据源流式关联引擎</span></a></div></div></li><li role="treeitem"><div data-tocid="streamha-d9713e4783" class="topicref" data-id="streamha" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_ha.html" id="streamha-d9713e4783-link"><span class="keyword label">流数据高可用</span></a></div></div></li><li role="treeitem"><div data-tocid="流计算状态监控-d9713e4830" class="topicref" data-id="流计算状态监控" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_monitor.html" id="流计算状态监控-d9713e4830-link">流计算状态监控</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="replay-d9713e4876" class="topicref" data-id="replay" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action replay-d9713e4876-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_replay.html" id="replay-d9713e4876-link"><span class="keyword label">历史数据回放</span></a></div></div></li><li role="treeitem"><div data-tocid="流批一体功能-d9713e5061" class="topicref" data-id="流批一体功能" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_batch.html" id="流批一体功能-d9713e5061-link"><span class="keyword label">流批一体</span></a></div></div></li><li role="treeitem"><div data-tocid="streamengineparser-解析原理介绍-d9713e5108" class="topicref" data-id="streamengineparser-解析原理介绍" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_eng_parser.html" id="streamengineparser-解析原理介绍-d9713e5108-link">StreamEngineParser 解析原理</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="realtime_data_acces-d9713e5155" class="topicref" data-id="realtime_data_acces" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action realtime_data_acces-d9713e5155-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/realtime_data_acces.html" id="realtime_data_acces-d9713e5155-link">实时流数据接入</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="cep-d9713e5617" class="topicref" data-id="cep" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action cep-d9713e5617-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/cep.html" id="cep-d9713e5617-link">复杂事件处理（CEP）引擎</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e6123" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e6123-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/local_sub.html" id="tocId-d9713e6123-link">流处理结果交互方式</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e6312" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e6312-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_altair.html" id="tocId-d9713e6312-link">数据可视化工具</a></div></div></li><li role="treeitem" aria-expanded="true"><div data-tocid="tocId-d9713e6405" class="topicref" data-state="expanded"><span role="button" tabindex="0" aria-labelledby="button-collapse-action tocId-d9713e6405-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_auto_sub.html" id="tocId-d9713e6405-link">金融场景应用案例</a></div></div><ul role="group" class="navbar-nav nav-list"><li role="treeitem"><div data-tocid="节点启动时的流计算自动订阅-d9713e6406" class="topicref" data-id="节点启动时的流计算自动订阅" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_auto_sub.html" id="节点启动时的流计算自动订阅-d9713e6406-link">节点启动时的流计算自动订阅</a></div></div></li><li role="treeitem"><div data-tocid="k-线计算-d9713e6452" class="topicref" data-id="k-线计算" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/OHLC.html" id="k-线计算-d9713e6452-link">K 线计算</a></div></div></li><li role="treeitem"><div data-tocid="金融因子流式实现-d9713e6498" class="topicref" data-id="金融因子流式实现" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/str_comp_fin_quant.html" id="金融因子流式实现-d9713e6498-link">金融因子流式实现</a></div></div></li><li role="treeitem"><div data-tocid="多数据源流式实时关联处理-d9713e6544" class="topicref" data-id="多数据源流式实时关联处理" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming-real-time-correlation-processing.html" id="多数据源流式实时关联处理-d9713e6544-link">多数据源流式实时关联处理</a></div></div></li><li role="treeitem"><div data-tocid="实时计算高频因子-d9713e6590" class="topicref" data-id="实时计算高频因子" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/hf_factor_streaming.html" id="实时计算高频因子-d9713e6590-link">实时计算高频因子</a></div></div></li><li role="treeitem"><div data-tocid="股票行情回放-d9713e6636" class="topicref" data-id="股票行情回放" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/stock_market_replay.html" id="股票行情回放-d9713e6636-link">股票行情回放</a></div></div></li><li role="treeitem"><div data-tocid="金融实时实际波动率预测-d9713e6682" class="topicref" data-id="金融实时实际波动率预测" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/ml_volatility.html" id="金融实时实际波动率预测-d9713e6682-link">金融实时实际波动率预测</a></div></div></li><li role="treeitem"><div data-tocid="开发股票波动率预测模型的-676-个输入特征-d9713e6728" class="topicref" data-id="开发股票波动率预测模型的-676-个输入特征" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/metacode_derived_features.html" id="开发股票波动率预测模型的-676-个输入特征-d9713e6728-link">开发股票波动率预测模型的 676 个输入特征</a></div></div></li><li role="treeitem"><div data-tocid="实时计算日累计逐单资金流-d9713e6774" class="topicref" data-id="实时计算日累计逐单资金流" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_capital_flow_daily.html" id="实时计算日累计逐单资金流-d9713e6774-link">实时计算日累计逐单资金流</a></div></div></li><li role="treeitem"><div data-tocid="实时计算分钟资金流-d9713e6820" class="topicref" data-id="实时计算分钟资金流" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_capital_flow_order_by_order.html" id="实时计算分钟资金流-d9713e6820-link">实时计算分钟资金流</a></div></div></li><li role="treeitem"><div data-tocid="流式计算中证-1000-指数主买主卖交易量-d9713e6866" class="topicref" data-id="流式计算中证-1000-指数主买主卖交易量" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/CSI_1000.html" id="流式计算中证-1000-指数主买主卖交易量-d9713e6866-link">流式计算中证 1000 指数主买/主卖交易量</a></div></div></li><li role="treeitem"><div data-tocid="快速搭建-level-2-快照数据流批一体因子计算平台最佳实践-d9713e6913" class="topicref" data-id="快速搭建-level-2-快照数据流批一体因子计算平台最佳实践" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/l2_snapshot_factor_calc.html" id="快速搭建-level-2-快照数据流批一体因子计算平台最佳实践-d9713e6913-link">快速搭建 Level-2 快照数据流批一体因子计算平台最佳实践</a></div></div></li><li role="treeitem"><div data-tocid="处理-level-2-行情数据实例-d9713e6959" class="topicref" data-id="处理-level-2-行情数据实例" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/l2_stk_data_proc.html" id="处理-level-2-行情数据实例-d9713e6959-link">处理 Level-2 行情数据实例</a></div></div></li><li role="treeitem"><div data-tocid="实时计算涨幅榜-d9713e7005" class="topicref" data-id="实时计算涨幅榜" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/rt_stk_price_inc_calc.html" id="实时计算涨幅榜-d9713e7005-link">实时计算涨幅榜</a></div></div></li><li role="treeitem" class="active"><div data-tocid="基金份额参考价值-iopv-计算-d9713e7051" class="topicref" data-id="基金份额参考价值-iopv-计算" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_IOPV.html" id="基金份额参考价值-iopv-计算-d9713e7051-link">基金份额参考价值 IOPV 计算</a></div></div></li></ul></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e7097" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e7097-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/ddb_str_app_iot.html" id="tocId-d9713e7097-link">物联网场景应用案例</a></div></div></li></ul></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e7513" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e7513-link" class="wh-expand-btn"></span><div class="title"><a href="../db_distr_comp/db_oper/import_data.html" id="tocId-d9713e7513-link">数据迁移</a><div class="wh-tooltip"><p class="shortdesc">如何从不同数据源向 DolphinDB 迁移数据</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap7_tutorials_system_management-d9713e7940" class="topicref" data-id="chap7_tutorials_system_management" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap7_tutorials_system_management-d9713e7940-link" class="wh-expand-btn"></span><div class="title"><a href="../sys_man/om_intro.html" id="chap7_tutorials_system_management-d9713e7940-link"><span class="keyword label">系统运维</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 的系统运维功能及方法</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="troubleshooting-d9713e8780" class="topicref" data-id="troubleshooting" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action troubleshooting-d9713e8780-link" class="wh-expand-btn"></span><div class="title"><a href="../error_codes/troubleshooting.html" id="troubleshooting-d9713e8780-link">故障排查</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="about_language_resources-d9713e20911" class="topicref" data-id="about_language_resources" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action about_language_resources-d9713e20911-link" class="wh-expand-btn"></span><div class="title"><a href="../progr/progr_intro.html" id="about_language_resources-d9713e20911-link"><span class="keyword label">编程语言</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 编程基本概念与方法、SQL 在 DolphinDB 的应用</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="functions_references-d9713e30925" class="topicref" data-id="functions_references" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action functions_references-d9713e30925-link" class="wh-expand-btn"></span><div class="title"><a href="../funcs/funcs_intro.html" id="functions_references-d9713e30925-link"><span class="keyword label">函数参考</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 函数分类、语法、详解及示例</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="api_protocol-d9713e94064" class="topicref" data-id="api_protocol" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action api_protocol-d9713e94064-link" class="wh-expand-btn"></span><div class="title"><a href="../api/connapi_intro.html" id="api_protocol-d9713e94064-link"><span class="keyword label">连接器 &amp; API</span></a><div class="wh-tooltip"><p class="shortdesc">面向不同编程语言的 DolphinDB API 及连接器，相关协议和用法</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap6_plugin-d9713e94210" class="topicref" data-id="chap6_plugin" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap6_plugin-d9713e94210-link" class="wh-expand-btn"></span><div class="title"><a href="../plugins/plg_intro.html" id="chap6_plugin-d9713e94210-link"><span class="keyword label">插件</span></a><div class="wh-tooltip"><p class="shortdesc">多个应用场景的插件使用说明和插件开发指导</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="third_party-d9713e97904" class="topicref" data-id="third_party" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action third_party-d9713e97904-link" class="wh-expand-btn"></span><div class="title"><a href="../third_party.html" id="third_party-d9713e97904-link">第三方工具</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="about_tutorials-d9713e98227" class="topicref" data-id="about_tutorials" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action about_tutorials-d9713e98227-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/about_tutorials.html" id="about_tutorials-d9713e98227-link"><span class="keyword label">教程</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 产品使用教程</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e105982" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e105982-link" class="wh-expand-btn"></span><div class="title"><a href="../rn/server/3_00_2.html" id="tocId-d9713e105982-link">版本说明</a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 版本发布历史</p></div></div></div></li></ul></div>
		                        
                            </div>
                        </nav>
                    
                    
                    <div class="col-lg-7 col-md-9 col-sm-12" id="wh_topic_body">
                        <button id="wh_close_publication_toc_button" class="close-toc-button d-none" aria-label="Toggle publishing table of content" aria-controls="wh_publication_toc" aria-expanded="true">
                            <span class="close-toc-icon-container">
                                <span class="close-toc-icon"></span>     
                            </span>
                        </button>
                        <button id="wh_close_topic_toc_button" class="close-toc-button d-none" aria-label="Toggle topic table of content" aria-controls="wh_topic_toc" aria-expanded="true">
                            <span class="close-toc-icon-container">
                                <span class="close-toc-icon"></span>     
                            </span>
                        </button>
                        
                        <div class=" wh_topic_content body "><main role="main"><article class="- topic/topic topic" role="article" aria-labelledby="ariaid-title1"><h1 class="- topic/title title topictitle1" id="ariaid-title1">基金份额参考价值 IOPV 计算</h1><div class="- topic/body body"><p class="- topic/p p">Indicative Optimized Portfolio Value (IOPV) 全称为基金份额参考净值，是由交易所计算的 ETF 实时单位净值的近似值，便于投资者估计 ETF 交易价格是否偏离了其内在价值。ETF 最新价为场内价格，是该 ETF 在二级市场交易的买卖价格。而 IOPV 是这只 ETF 在一级市场的报价，即为 ETF 的净值。IOPV 是 ETF 基金特有，是场内 ETF 的参考值，方便投资者参与套利。</p><p class="- topic/p p">目前交易所每隔 15 秒公开发布 IOPV 行情。本教程介绍如何使用 DolphinDB 实时计算 ETF 的 IOPV，亦即任何成分股的交易价格发生变化时，重新计算 EFT 的最新 IOPV。这将给量化策略更多多操作空间。
生产环境中实时计算主要有 3 个要求：(1) 能够实现 IOPV 复杂计算；(2) 计算快、交易信号捕捉要灵敏；(3) 具备从行情输入、计算到结果输出完整的实时处理能力。</p><p class="- topic/p p">本教程中将会学习到:</p><ul class="- topic/ul ul"><li class="- topic/li li">使用<code class="+ topic/ph pr-d/codeph ph codeph">pivot</code>处理面板数据</li><li class="- topic/li li">使用行情回放函数<code class="+ topic/ph pr-d/codeph ph codeph">replayDS</code></li><li class="- topic/li li">如何进行增量计算</li><li class="- topic/li li">流式计算横截面引擎<code class="+ topic/ph pr-d/codeph ph codeph">CrossSectionalEngine</code>，响应式状态引擎<code class="+ topic/ph pr-d/codeph ph codeph">ReactiveStateEngine</code></li><li class="- topic/li li">函数<code class="+ topic/ph pr-d/codeph ph codeph">ffill</code>, <code class="+ topic/ph pr-d/codeph ph codeph">rowSum</code></li><li class="- topic/li li">使用消息中间件<code class="+ topic/ph pr-d/codeph ph codeph">zmq</code></li></ul></div><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title2" id="1-计算公式"><h2 class="- topic/title title topictitle2" id="ariaid-title2">1. 计算公式</h2><div class="- topic/body body"></div><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title3" id="11-标准-iopv-计算公式"><h3 class="- topic/title title topictitle3" id="ariaid-title3">1.1. 标准 IOPV 计算公式</h3><div class="- topic/body body"><p class="- topic/p p">计算公式如下：</p><br/><img class="- topic/image image" src="images/streaming_IOPV/iopv.png"/><br/><ul class="- topic/ul ul"><li class="- topic/li li">P_i：T 日申购赎回清单中第 i 只成分券的实时价格，取净价</li><li class="- topic/li li">Shares_i：T 日申购赎回清单中第 i 只成分券的数量（单位：手）</li><li class="- topic/li li">AI：T 日申购赎回清单中所有成分券在 T 日的应计利息总和</li><li class="- topic/li li">ECC：T 日申购赎回清单中的预估现金部分（Estimated Cash Component）</li></ul></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title4" id="12-本教程-iopv-计算公式"><h3 class="- topic/title title topictitle3" id="ariaid-title4">1.2. 本教程 IOPV 计算公式</h3><div class="- topic/body body"><p class="- topic/p p">在无法获得 ETF 基金参考数据源的情况下，我们采用数据模拟构建的方式，因此有以下调整。</p><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">成分券构建</strong></p><p class="- topic/p p">假设每只基金都为 50 只成分券，采用固定和随机两种方式构建成分券。</p><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">计算公式调整</strong></p><br/><img class="- topic/image image" src="images/streaming_IOPV/IOPV-adjust.png"/><br/><p class="- topic/p p">不将 AI 和 ECC 纳入 IOPV 计算公式中，对计算方法和计算性能影响较小。</p></div></article></article><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title5" id="2-指数构建"><h2 class="- topic/title title topictitle2" id="ariaid-title5">2. 指数构建</h2><div class="- topic/body body"><p class="- topic/p p">固定标的构建用于单只指数的历史和实时 IOPV 计算，随机标的构建用于多只指数的实时 IOPV 计算。</p></div><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title6" id="21-固定标的构建"><h3 class="- topic/title title topictitle3" id="ariaid-title6">2.1. 固定标的构建</h3><div class="- topic/body body"><p class="- topic/p p">选取 50 只深市股票作为成分券，并为每只成分券设置一个随机仓位，然后构建一个 “字典” 类型的指数。</p><pre class="+ topic/pre pr-d/codeblock pre codeblock python">symbols = `<span class="hl-number">300073</span>`<span class="hl-number">300363</span>`<span class="hl-number">300373</span>`<span class="hl-number">300474</span>`<span class="hl-number">300682</span>`<span class="hl-number">300769</span>`<span class="hl-number">301029</span>`<span class="hl-number">300390</span>`<span class="hl-number">300957</span>`<span class="hl-number">300763</span>`<span class="hl-number">300979</span>`<span class="hl-number">300919</span>`<span class="hl-number">300037</span>`<span class="hl-number">300832</span>`<span class="hl-number">300866</span>`<span class="hl-number">300896</span>`<span class="hl-number">300751</span>`<span class="hl-number">300223</span>`<span class="hl-number">300676</span>`<span class="hl-number">300274</span>`<span class="hl-number">300413</span>`<span class="hl-number">300496</span>`<span class="hl-number">300661</span>`<span class="hl-number">300782</span>`<span class="hl-number">300142</span>`<span class="hl-number">300759</span>`<span class="hl-number">300595</span>`<span class="hl-number">300285</span>`<span class="hl-number">300146</span>`<span class="hl-number">300207</span>`<span class="hl-number">300316</span>`<span class="hl-number">300454</span>`<span class="hl-number">300529</span>`<span class="hl-number">300699</span>`<span class="hl-number">300628</span>`<span class="hl-number">300760</span>`<span class="hl-number">300601</span>`<span class="hl-number">300450</span>`<span class="hl-number">300433</span>`<span class="hl-number">300408</span>`<span class="hl-number">300347</span>`<span class="hl-number">300124</span>`<span class="hl-number">300122</span>`<span class="hl-number">300059</span>`<span class="hl-number">300033</span>`<span class="hl-number">300015</span>`<span class="hl-number">300014</span>`<span class="hl-number">300012</span>`<span class="hl-number">300003</span>`<span class="hl-number">300750</span>
positions = rand(<span class="hl-number">76339.</span><span class="hl-number">.145256</span>, <span class="hl-number">50</span>)
portfolio = dict(symbols, positions)</pre></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title7" id="22-随机标的构建"><h3 class="- topic/title title topictitle3" id="ariaid-title7">2.2. 随机标的构建</h3><div class="- topic/body body"><p class="- topic/p p"><code class="+ topic/ph pr-d/codeph ph codeph">getBasketData()</code> 函数会构建100只指数，在深市股票逐笔成交中随机选取50只股票作为成分股，并设置随机仓位。</p><pre class="+ topic/pre pr-d/codeblock pre codeblock python"><strong class="hl-keyword">def</strong> getBasketData(allSymbol, n){
        <strong class="hl-keyword">return</strong> loop(x-&gt;table(take(x, <span class="hl-number">50</span>) <strong class="hl-keyword">as</strong> BasketID, rand(allSymbol, <span class="hl-number">50</span>) <strong class="hl-keyword">as</strong> SecurityID, rand(<span class="hl-number">76339.</span><span class="hl-number">.145256</span>, <span class="hl-number">50</span>) <strong class="hl-keyword">as</strong> Vol), <span class="hl-number">1.</span>.n).unionAll(false)
}

trade = loadTable(<span class="hl-string">"dfs://LEVEL2_SZ"</span>,<span class="hl-string">"Trade"</span>)
allSyms = select count(*) <strong class="hl-keyword">from</strong> trade where date(tradetime) = <span class="hl-number">2020.01</span>.<span class="hl-number">02</span> group by SecurityID
basket = getBasketData(allSyms.SecurityID, <span class="hl-number">100</span>)</pre></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title8" id="23-逐笔成交数据表结构"><h3 class="- topic/title title topictitle3" id="ariaid-title8">2.3. 逐笔成交数据表结构</h3><div class="- topic/body body"><p class="- topic/p p">采用深交所 Level2 逐笔成交进行 IOPV 计算，表结构如下：</p><div class="table-container"><table class="- topic/table table" data-cols="4"><caption></caption><colgroup><col/><col/><col/><col/></colgroup><thead class="- topic/thead thead"><tr class="- topic/row"><th class="- topic/entry entry colsep-0 rowsep-0" id="23-逐笔成交数据表结构__entry__1">name</th><th class="- topic/entry entry colsep-0 rowsep-0" id="23-逐笔成交数据表结构__entry__2">typeString</th><th class="- topic/entry entry colsep-0 rowsep-0" id="23-逐笔成交数据表结构__entry__3">typeInt</th><th class="- topic/entry entry colsep-0 rowsep-0" id="23-逐笔成交数据表结构__entry__4">comment</th></tr></thead><tbody class="- topic/tbody tbody"><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">tradedate</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">DATE</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">6</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">OrigTime</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">TIMESTAMP</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">12</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">SendTime</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">TIMESTAMP</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">12</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">recvtime</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">TIMESTAMP</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">12</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">dbtime</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">TIMESTAMP</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">12</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">ChannelNo</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">INT</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">4</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">MDStreamID</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">SYMBOL</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">17</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">ApplSeqNum</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">LONG</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">5</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">SecurityID</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">SYMBOL</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">17</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">SecurityIDSource</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">SYMBOL</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">17</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">BidApplSeqNum</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">INT</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">4</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">OfferApplSeqNum</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">INT</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">4</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">Price</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">DOUBLE</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">16</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">TradeQty</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">INT</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">4</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">ExecType</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">SYMBOL</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">17</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__1">tradetime</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__2">TIMESTAMP</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__3">12</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="23-逐笔成交数据表结构__entry__4"> </td></tr></tbody></table></div></div></article></article><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title9" id="3-历史-iopv-计算"><h2 class="- topic/title title topictitle2" id="ariaid-title9">3. 历史 IOPV 计算</h2><div class="- topic/body body"></div><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title10" id="31-传统-iopv-计算方法"><h3 class="- topic/title title topictitle3" id="ariaid-title10">3.1. 传统 IOPV 计算方法</h3><div class="- topic/body body"><p class="- topic/p p">基于历史逐笔成交计算更细颗粒度的 IOPV，传统计算方法如下：</p><p class="- topic/p p">将50只成分券的所有逐笔数据合并，并按照时间戳排序。计算时按时间戳遍历股票数据，计算每个时间戳 50 只股票的总价值，作为当前时间戳的 IOPV。若某一时间戳下，存在股票数据缺失，则用前一时间戳下该股票的数据进行填充。在程序中需要分别记录50只股票最近一个时间戳的价格并随时更新。</p><p class="- topic/p p">传统计算方法有几点不足：</p><ol class="- topic/ol ol"><li class="- topic/li li">传统方法采用循环的方式遍历计算，导致性能不高。</li><li class="- topic/li li">会存在不同股票相同时间戳的数据，需要代码判断读到最新时间戳才能触发汇总计算逻辑，导致代码复杂。</li><li class="- topic/li li">需要把前一股票价值手工存储在一个变量里，并随时更新这个变量，导致代码复杂。</li></ol><p class="- topic/p p">因此，基于逐笔成交的传统 IOPV 计算方法会有耗时长和代码复杂两个缺点。</p></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title11" id="32-dolphindb-数据面板计算方法"><h3 class="- topic/title title topictitle3" id="ariaid-title11">3.2. DolphinDB 数据面板计算方法</h3><div class="- topic/body body"><p class="- topic/p p">在 DolphinDB 中利用 <code class="+ topic/ph pr-d/codeph ph codeph">pivot by</code> 生成一个数据面板（矩阵），再对矩阵进行向量化运算可以提高计算速度，同时代码更为简洁。</p><pre class="+ topic/pre pr-d/codeblock pre codeblock python">timeSeriesValue = select tradetime, SecurityID, price * portfolio[SecurityID]/<span class="hl-number">1000</span> <strong class="hl-keyword">as</strong> constituentValue <strong class="hl-keyword">from</strong> loadTable(<span class="hl-string">"dfs://LEVEL2_SZ"</span>,<span class="hl-string">"Trade"</span>) where SecurityID <strong class="hl-keyword">in</strong> portfolio.keys(), tradedate = <span class="hl-number">2020.12</span>.<span class="hl-number">01</span>, price &gt; <span class="hl-number">0</span>
iopvHist = select rowSum(ffill(constituentValue)) <strong class="hl-keyword">as</strong> IOPV <strong class="hl-keyword">from</strong> timeSeriesValue pivot by tradetime, SecurityID</pre><ol class="- topic/ol ol"><li class="- topic/li li">计算股票价值</li></ol><p class="- topic/p p">timeSeriesValue 得到每个时间戳下的所有成分券价值，本次代码示例计算深交所 2021.12.01 这一日的逐笔成交的历史 IOPV，其中 <code class="+ topic/ph pr-d/codeph ph codeph">loadTable("dfs://LEVEL2_SZ","Trade")</code> 使用的是逐笔成交表。</p><br/><img class="- topic/image image" src="images/streaming_IOPV/timeseriesvalue.png"/><br/><p class="- topic/p p">上图中 constituentValue 是每一时间戳时当前股票仓位的价值。</p><ol class="- topic/ol ol"><li class="- topic/li li">面板数据计算 IOPV</li></ol><p class="- topic/p p">利用 DolphinDB 中的 <code class="+ topic/ph pr-d/codeph ph codeph">pivot by</code> 数据透视功能生成一个面板数据，横轴是50只成分券，纵轴是时间戳，数据点代表每只成分券在一个时间戳上的价值。</p><br/><img class="- topic/image image" src="images/streaming_IOPV/iopv-pivot.png"/><br/><p class="- topic/p p">对面板数据的纵轴（时间序列）的空置填充最近前一笔有效价值，再对横轴（成分券）汇总即可得到每个时间戳上的 IOPV 结果。</p><ul class="- topic/ul ul"><li class="- topic/li li"><code class="+ topic/ph pr-d/codeph ph codeph">ffill</code>会找到前一笔最近的非空值，相当于传统方法取前一股票价值。</li><li class="- topic/li li"><code class="+ topic/ph pr-d/codeph ph codeph">rowSum</code>对横向行数据汇总，即把所有成分券的价值汇总得出 IOPV。</li></ul><p class="- topic/p p">在 DolphinDB 中使用一行代码就能完成传统 IOPV 计算步骤3中的复杂逻辑；同时，DolphinDB 是向量计算，能够充分利用多线程完成高效运算。</p><p class="- topic/p p">面板数据有以下优点，参考阅读 <a class="- topic/xref xref" href="https://cn.bing.com/search?q=Baltagi%2C%20Econometric%20Analysis%20of%20Panel%20Data&amp;qs=n&amp;form=QBRE&amp;=%25eManage%20Your%20Search%20History%25E&amp;sp=-1&amp;pq=baltagi%2C%20econometric%20analysis%20of%20panel%20data&amp;sc=1-43&amp;sk=&amp;cvid=E6E66A3E75864576AAA92648BF01B5D6&amp;ghsh=0&amp;ghacc=0&amp;ghpl=" target="_blank" rel="external noopener">Baltagi, Econometric Analysis of Panel Data</a> Chapter 1 <code class="+ topic/ph pr-d/codeph ph codeph">1.2 Why should we use Panel Data? The Benefits and Limitations</code>:</p><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">Benefits</strong></p><ul class="- topic/ul ul"><li class="- topic/li li">Controlling for individual heterogeneity.</li><li class="- topic/li li">Panel data give more informative data, more variablility, less collinearity among the variables, more degrees of freedom and more effciency.</li><li class="- topic/li li">Panel data are better able to study the dymanics of adjustment.</li><li class="- topic/li li">Panel data are better able to identify and measure effects that are simply not detectable in pure cross-section or pure time-series data.</li><li class="- topic/li li">Panel data models allow us to construct and test more complicated behavioral models than purely cross-section or time-series data.</li><li class="- topic/li li">Micro panel data gathered on individuals, firms and households may be more accurately measured than similar variables measured at the macro level.</li><li class="- topic/li li">Macro panel data on the other hand have a longer time series and unlike the problem of nonstandard distributions typical of units roots tests in time-series analysis.</li></ul><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">Limitations</strong></p><ul class="- topic/ul ul"><li class="- topic/li li">Design and data collection problems.</li><li class="- topic/li li">Distortions of measurement errors.</li><li class="- topic/li li">Selectivity problems.</li><li class="- topic/li li">Short time-series dimensions.</li><li class="- topic/li li">Cross-section dependence.</li></ul></div></article></article><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title12" id="4-单只-etf-实时计算"><h2 class="- topic/title title topictitle2" id="ariaid-title12">4. 单只 ETF 实时计算</h2><div class="- topic/body body"><p class="- topic/p p">案例代码展示从[数据接入]-&gt;[实时计算]-&gt;[下游系统消费]一个完整的流数据处理流程。</p><p class="- topic/p p">只要通过3段代码即可实现完整的业务逻辑：</p></div><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title13" id="41-数据接入-replayds历史行情回放"><h3 class="- topic/title title topictitle3" id="ariaid-title13">4.1. [数据接入] replayDS：历史行情回放</h3><div class="- topic/body body"><p class="- topic/p p">通过历史行情回放的形式模拟实时行情。使用 DolphinDB 内置的 <code class="+ topic/ph pr-d/codeph ph codeph">replayDS</code> 函数能够轻松实现数据回放，实际投研和生产中还可以使用 replayDS 多表联合回放成交、订单和快照行情。</p><pre class="+ topic/pre pr-d/codeblock pre codeblock python">t =  streamTable(<span class="hl-number">100</span>:<span class="hl-number">0</span>, `SecurityID`tradedate`tradetime`price,[SYMBOL, DATE,TIMESTAMP,DOUBLE])
enableTableShareAndPersistence(table=t, tableName=`TradeStreamData, cacheSize=<span class="hl-number">1000000</span>)
rds = replayDS(&lt;select   SecurityID, tradedate, tradetime , price <strong class="hl-keyword">from</strong> loadTable(<span class="hl-string">"dfs://LEVEL2_SZ"</span>,<span class="hl-string">"Trade"</span>) where tradedate = <span class="hl-number">2020.12</span>.<span class="hl-number">01</span>, price&gt;<span class="hl-number">0</span>  &gt;, `tradedate, `tradetime,  cutPoints(<span class="hl-number">09</span>:<span class="hl-number">30</span>:<span class="hl-number">00.000</span>.<span class="hl-number">.16</span>:<span class="hl-number">00</span>:<span class="hl-number">00.000</span>, <span class="hl-number">60</span>));
submitJob(<span class="hl-string">"replay_order"</span>, <span class="hl-string">"replay_trades_stream"</span>,  replay,  rds,  `TradeStreamData, `tradedate, `tradetime, <span class="hl-number">1000000</span>, true, <span class="hl-number">4</span>)</pre><p class="- topic/p p">上段代码回放了 2020.12.01 这一天的逐笔成交数据，并把回放数据写入到流数据表 <code class="+ topic/ph pr-d/codeph ph codeph">TradeStreamData</code> 中。</p></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title14" id="42-实时计算-iopv-横截面计算"><h3 class="- topic/title title topictitle3" id="ariaid-title14">4.2. [实时计算] IOPV 横截面计算</h3><div class="- topic/body body"><p class="- topic/p p">使用横截面计算引擎 <code class="+ topic/ph pr-d/codeph ph codeph">CrossSectionalEngine</code> 计算 IOPV</p><pre class="+ topic/pre pr-d/codeblock pre codeblock python">share streamTable(<span class="hl-number">1000</span>:<span class="hl-number">0</span>, `tradetime`tradedate`IOPV, [TIMESTAMP,DATE,DOUBLE]) <strong class="hl-keyword">as</strong> IOPVStreamResult
IOPV_engine = createCrossSectionalEngine(name=<span class="hl-string">"IOPV_calculator"</span>, metrics=[&lt;last(tradedate)&gt;, &lt;sum(ffill(price) * portfolio[SecurityID]/<span class="hl-number">1000</span>)&gt;],  dummyTable=TradeStreamData, outputTable=IOPVStreamResult, keyColumn=`SecurityID, triggeringPattern=<span class="hl-string">'perRow'</span>,  timeColumn=`tradetime, useSystemTime=false)
setStreamTableFilterColumn(TradeStreamData, `SecurityID)
subscribeTable(tableName=<span class="hl-string">"TradeStreamData"</span>, actionName=<span class="hl-string">"trade_subscribe"</span>, offset=<span class="hl-number">0</span>, handler=append!{IOPV_engine}, msgAsTable=true, batchSize=<span class="hl-number">10000</span>, throttle=<span class="hl-number">1</span>, hash=<span class="hl-number">0</span>, filter=portfolio.keys());</pre><ul class="- topic/ul ul"><li class="- topic/li li">上段代码首先创建了流表 <code class="+ topic/ph pr-d/codeph ph codeph">IOPVStreamResult</code>，将在这个流表中存储 IOPV 计算结果；</li><li class="- topic/li li"><code class="+ topic/ph pr-d/codeph ph codeph">IOPV_engine</code> 行实现了 IOPV 的业务逻辑，由于 IOPV 也是一个横截面计算，这里使用了横截面引擎；</li><li class="- topic/li li">最后 subscribeTable 的时候执行 <code class="+ topic/ph pr-d/codeph ph codeph">IOPV_engine</code> 计算引擎，只读取成分券 <code class="+ topic/ph pr-d/codeph ph codeph">portfolio.key()</code> 的行情数据，这种数据过滤处理可以提高执行速度。</li></ul><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">横截面计算逻辑</strong>：</p><ul class="- topic/ul ul"><li class="- topic/li li">横截面计算 (<code class="+ topic/ph pr-d/codeph ph codeph">createCrossSectionalEngine</code>)，顾名思义就是一个时间戳（时间截面）上的计算，也可以表述为多只股票的数据在同一时间截面 (同一时间戳）上的计算。在这个例子中，就是一个时间截面（时间戳）上需要汇总（sum）所有的股票价值得到净值。</li><li class="- topic/li li">在实时 IOPV 计算时，只要收到了一只成分券的最新价格，就计算一次 IOPV，所以设置了 <code class="+ topic/ph pr-d/codeph ph codeph">triggeringPattern='perRow'</code>；代表只要收到一笔新的逐笔成交行情，就会触发一次 IOPV 计算。</li><li class="- topic/li li"><code class="+ topic/ph pr-d/codeph ph codeph">metrics=[&lt;last(tradedate)&gt;, &lt;sum(ffill(price) * portfolio[SecurityID]/1000)&gt;]</code> 是 IOPV 计算的业务逻辑。</li></ul></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title15" id="43-下游系统消费通过-zmq-消费计算结果"><h3 class="- topic/title title topictitle3" id="ariaid-title15">4.3. [下游系统消费]通过 ZMQ 消费计算结果</h3><div class="- topic/body body"><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>try{
    formatter = zmq::createJSONFormatter()
    socket = zmq::socket("ZMQ_PUB", formatter)
    zmq::bind(socket, "tcp://*:20414")
}catch(ex){}

subscribeTable(tableName="IOPVStreamResult", actionName="IOPV_mq_read", offset=0, handler=zmq::send{socket}, msgAsTable=true)</code></pre><ul class="- topic/ul ul"><li class="- topic/li li">在下游系统中订阅数据时通过 ZMQ handler 接收数据</li><li class="- topic/li li">下游系统根据实时 IOPV 创建交易策略（本教程未包含策略实现</li><li class="- topic/li li">参考<a class="- topic/xref xref" href="https://gitee.com/dolphindb/DolphinDBPlugin/blob/release200/zmq/README.md" target="_blank" rel="external noopener">DolphinDB zmq Plugin</a></li></ul></div></article></article><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title16" id="5-多只-etf-实时增量计算"><h2 class="- topic/title title topictitle2" id="ariaid-title16">5. 多只 ETF 实时增量计算</h2><div class="- topic/body body"><p class="- topic/p p">计算全市场500多只 ETF IOPV 时，如果使用实时计算（单只-etf-实时计算）的方法，由于每次收到新的逐笔成交就要做一次汇总，计算量会非常庞大，因此不是最优方案。通过 DolphinDB 响应式状态引擎增量计算，可以大幅降低算法计算步骤，计算更加高效。</p><p class="- topic/p p">核心代码如下：</p></div><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title17" id="51-过滤价格不变数据"><h3 class="- topic/title title topictitle3" id="ariaid-title17">5.1. 过滤价格不变数据</h3><div class="- topic/body body"><p class="- topic/p p">基于逐笔数据，两个相邻行情中有大量最新价一致的数据，首先可以过滤这些数据，在增量计算中他们不对净值结果产生影响。</p><pre class="+ topic/pre pr-d/codeblock pre codeblock python">metricsFuc = [
    &lt;tradetime&gt;,
    &lt;Price&gt;]
createReactiveStateEngine(name=<span class="hl-string">"tradeProcessPriceChange"</span>, metrics=metricsFuc, dummyTable=tradeOriginalStream, outputTable=tradeOriginalStream, keyColumn=`SecurityID, filter=&lt;deltas(Price) != <span class="hl-number">0</span>&gt;, keepOrder=true)</pre><p class="- topic/p p">上段代码只会把 <code class="+ topic/ph pr-d/codeph ph codeph">deltas(Price) != 0</code>，即价格发生了变化的股票用于后续的估值计算。</p></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title18" id="52-增量算子计算"><h3 class="- topic/title title topictitle3" id="ariaid-title18">5.2. 增量算子计算</h3><div class="- topic/body body"><p class="- topic/p p">只计算变化量.</p><pre class="+ topic/pre pr-d/codeblock pre codeblock python">metricsProcess = [
    &lt;tradetime&gt;,
    &lt;deltas(Price*Vol/<span class="hl-number">1000</span>)&gt;]
createReactiveStateEngine(name=<span class="hl-string">"tradeProcessIOPVChange"</span>, metrics=metricsProcess, dummyTable=tradeProcessDummy, outputTable=getStreamEngine(`IOPVResult), keyColumn=`BasketID`SecurityID, keepOrder=true)</pre><p class="- topic/p p">上端代码中通过元代码 <code class="+ topic/ph pr-d/codeph ph codeph">&lt;deltas(Price*Vol/1000)&gt;</code> 计算 delta 变化量，即增量算子。</p></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title19" id="53-增量计算"><h3 class="- topic/title title topictitle3" id="ariaid-title19">5.3. 增量计算</h3><div class="- topic/body body"><p class="- topic/p p">DolphinDB 内置的累计聚合函数 <code class="+ topic/ph pr-d/codeph ph codeph">cumsum</code> 实现了增量计算。</p><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>metricsResult = [
    &lt;tradetime&gt;,
    &lt;cumsum(deltaValue)&gt;]
createReactiveStateEngine(name="IOPVResult", metrics=metricsResult, dummyTable=tradeResultDummy, outputTable=IOPVResult, keyColumn=`BasketID, keepOrder=true)</code></pre><p class="- topic/p p">响应式状态引擎的增量计算逻辑如下：</p><br/><img class="- topic/image image" src="images/streaming_IOPV/incrumental_computing.png"/><br/><ol class="- topic/ol ol"><li class="- topic/li li">我们先简单创建一张估值表，包含 <code class="+ topic/ph pr-d/codeph ph codeph">"securityID","price","vol","value"</code> 四个字段，其中 <code class="+ topic/ph pr-d/codeph ph codeph">value=price*vol</code>。</li><li class="- topic/li li">计算 IOPV*1000，只需要把10只票的价值相加即可。</li><li class="- topic/li li"><code class="+ topic/ph pr-d/codeph ph codeph">securityID=1</code> 这只票的价格发生了变化，变成了 <code class="+ topic/ph pr-d/codeph ph codeph">15.41</code>。</li><li class="- topic/li li">只需要计算变化量 <code class="+ topic/ph pr-d/codeph ph codeph">deltas= (new price – last price) * vol</code></li><li class="- topic/li li">增量计算净值 <code class="+ topic/ph pr-d/codeph ph codeph">New IOPV*1000= Last IOPV * 1000 + deltas</code>，这种算法的时间复杂度最低，不再需要 <code class="+ topic/ph pr-d/codeph ph codeph">rowSum</code> 计算。非增量算法如图所示计算量较大。</li><li class="- topic/li li">在示例中有段 <code class="+ topic/ph pr-d/codeph ph codeph">&lt;filter=&lt;deltas(Price) != 0&gt;</code> 过滤器代码，如果价格没有变化，则净值不会变化，不需要计算。相当于实现了 <code class="+ topic/ph pr-d/codeph ph codeph">ffill</code>。</li></ol><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">注意</strong>：采用响应式式状态引擎 ReactiveStateEngine 的主要作用是需要记录计算过程中的状态。如图公式 deltas= (new price – last price) * vol, 该公式中的 <em class="+ topic/ph hi-d/i ph i">price</em> 和 <em class="+ topic/ph hi-d/i ph i">vol</em> 只能是 securitID=1 的价格和持仓量，也称为需要记录 “状态”。</p></div></article></article><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title20" id="6-回顾"><h2 class="- topic/title title topictitle2" id="ariaid-title20">6. 回顾</h2><div class="- topic/body body"><p class="- topic/p p">本教程展示了基于 DolphinDB 的多种 IOPV 计算方法。</p><ul class="- topic/ul ul"><li class="- topic/li li">历史 IOPV 计算: 学习了使用 <code class="+ topic/ph pr-d/codeph ph codeph">piovt</code> 进行面板数据处理，<code class="+ topic/ph pr-d/codeph ph codeph">pivot by</code> 是 DolphinDB 中极为常用的数据处理方式，与 python 中的 DataFrame 极为类似，使用 <code class="+ topic/ph pr-d/codeph ph codeph">pivot by</code> 可以数据处理简单和高效。</li><li class="- topic/li li">单只 ETF 实时计算: 学习了横截面计算引擎和实时数据[数据接入]-&gt;[实时计算]-&gt;[下游系统消费]完整的处理流程。</li><li class="- topic/li li">多只 ETF 实时计算: 学习了通过响应式状态引擎实现增量计算，相较于 “单只指数实时计算”，其计算效率更高。</li></ul></div></article><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title21" id="7-源代码"><h2 class="- topic/title title topictitle2" id="ariaid-title21">7. 源代码</h2><div class="- topic/body body"><ol class="- topic/ol ol"><li class="- topic/li li"><a class="- topic/xref xref" href="script/streaming_IOPV/1.%20IOPV_hist.dos">历史 IOPV 计算</a></li><li class="- topic/li li"><a class="- topic/xref xref" href="script/streaming_IOPV/2.%20IOPV_realtime_single.dos">单只 ETF 实时计算 IOPV</a></li><li class="- topic/li li"><a class="- topic/xref xref" href="script/streaming_IOPV/3.%20IOPV_realtime_mult.dos">多只 ETF 实时增量计算 IOPV</a></li></ol></div></article></article></main></div>
                        
                        
                        
                        
                        
                        
                    </div>
                    
                        <nav role="navigation" id="wh_topic_toc" aria-label="On this page" class="col-lg-2 d-none d-lg-block navbar d-print-none"> 
                            <div id="wh_topic_toc_content">
		                        
	                            <div class=" wh_topic_toc "><div class="wh_topic_label">在本页上</div><ul><li class="topic-item"><a href="#1-%E8%AE%A1%E7%AE%97%E5%85%AC%E5%BC%8F" data-tocid="1-计算公式">1. 计算公式</a><ul><li class="topic-item"><a href="#11-%E6%A0%87%E5%87%86-iopv-%E8%AE%A1%E7%AE%97%E5%85%AC%E5%BC%8F" data-tocid="11-标准-iopv-计算公式">1.1. 标准 IOPV 计算公式</a></li><li class="topic-item"><a href="#12-%E6%9C%AC%E6%95%99%E7%A8%8B-iopv-%E8%AE%A1%E7%AE%97%E5%85%AC%E5%BC%8F" data-tocid="12-本教程-iopv-计算公式">1.2. 本教程 IOPV 计算公式</a></li></ul></li><li class="topic-item"><a href="#2-%E6%8C%87%E6%95%B0%E6%9E%84%E5%BB%BA" data-tocid="2-指数构建">2. 指数构建</a><ul><li class="topic-item"><a href="#21-%E5%9B%BA%E5%AE%9A%E6%A0%87%E7%9A%84%E6%9E%84%E5%BB%BA" data-tocid="21-固定标的构建">2.1. 固定标的构建</a></li><li class="topic-item"><a href="#22-%E9%9A%8F%E6%9C%BA%E6%A0%87%E7%9A%84%E6%9E%84%E5%BB%BA" data-tocid="22-随机标的构建">2.2. 随机标的构建</a></li><li class="topic-item"><a href="#23-%E9%80%90%E7%AC%94%E6%88%90%E4%BA%A4%E6%95%B0%E6%8D%AE%E8%A1%A8%E7%BB%93%E6%9E%84" data-tocid="23-逐笔成交数据表结构">2.3. 逐笔成交数据表结构</a></li></ul></li><li class="topic-item"><a href="#3-%E5%8E%86%E5%8F%B2-iopv-%E8%AE%A1%E7%AE%97" data-tocid="3-历史-iopv-计算">3. 历史 IOPV 计算</a><ul><li class="topic-item"><a href="#31-%E4%BC%A0%E7%BB%9F-iopv-%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95" data-tocid="31-传统-iopv-计算方法">3.1. 传统 IOPV 计算方法</a></li><li class="topic-item"><a href="#32-dolphindb-%E6%95%B0%E6%8D%AE%E9%9D%A2%E6%9D%BF%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95" data-tocid="32-dolphindb-数据面板计算方法">3.2. DolphinDB 数据面板计算方法</a></li></ul></li><li class="topic-item"><a href="#4-%E5%8D%95%E5%8F%AA-etf-%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97" data-tocid="4-单只-etf-实时计算">4. 单只 ETF 实时计算</a><ul><li class="topic-item"><a href="#41-%E6%95%B0%E6%8D%AE%E6%8E%A5%E5%85%A5-replayds%E5%8E%86%E5%8F%B2%E8%A1%8C%E6%83%85%E5%9B%9E%E6%94%BE" data-tocid="41-数据接入-replayds历史行情回放">4.1. [数据接入] replayDS：历史行情回放</a></li><li class="topic-item"><a href="#42-%E5%AE%9E%E6%97%B6%E8%AE%A1%E7%AE%97-iopv-%E6%A8%AA%E6%88%AA%E9%9D%A2%E8%AE%A1%E7%AE%97" data-tocid="42-实时计算-iopv-横截面计算">4.2. [实时计算] IOPV 横截面计算</a></li><li class="topic-item"><a href="#43-%E4%B8%8B%E6%B8%B8%E7%B3%BB%E7%BB%9F%E6%B6%88%E8%B4%B9%E9%80%9A%E8%BF%87-zmq-%E6%B6%88%E8%B4%B9%E8%AE%A1%E7%AE%97%E7%BB%93%E6%9E%9C" data-tocid="43-下游系统消费通过-zmq-消费计算结果">4.3. [下游系统消费]通过 ZMQ 消费计算结果</a></li></ul></li><li class="topic-item"><a href="#5-%E5%A4%9A%E5%8F%AA-etf-%E5%AE%9E%E6%97%B6%E5%A2%9E%E9%87%8F%E8%AE%A1%E7%AE%97" data-tocid="5-多只-etf-实时增量计算">5. 多只 ETF 实时增量计算</a><ul><li class="topic-item"><a href="#51-%E8%BF%87%E6%BB%A4%E4%BB%B7%E6%A0%BC%E4%B8%8D%E5%8F%98%E6%95%B0%E6%8D%AE" data-tocid="51-过滤价格不变数据">5.1. 过滤价格不变数据</a></li><li class="topic-item"><a href="#52-%E5%A2%9E%E9%87%8F%E7%AE%97%E5%AD%90%E8%AE%A1%E7%AE%97" data-tocid="52-增量算子计算">5.2. 增量算子计算</a></li><li class="topic-item"><a href="#53-%E5%A2%9E%E9%87%8F%E8%AE%A1%E7%AE%97" data-tocid="53-增量计算">5.3. 增量计算</a></li></ul></li><li class="topic-item"><a href="#6-%E5%9B%9E%E9%A1%BE" data-tocid="6-回顾">6. 回顾</a></li><li class="topic-item"><a href="#7-%E6%BA%90%E4%BB%A3%E7%A0%81" data-tocid="7-源代码">7. 源代码</a></li></ul></div>
	                        	
                        	</div>
                        </nav>
                    
                </div>
            </div>
            
            
            
        </div> 
        <footer class="navbar navbar-default wh_footer">
  <div class=" footer-container mx-auto ">
<title>Copyright</title><p><b> ©2025 浙江智臾科技有限公司 浙ICP备18048711号-3</b></p>
  </div>
</footer>
        
        <div id="go2top" class="d-print-none">
            <span class="oxy-icon oxy-icon-up"></span>
        </div>
        
        <div id="modal_img_large" class="modal">
            <span class="close oxy-icon oxy-icon-remove"></span>
            <div id="modal_img_container"></div>
            <div id="caption"></div>
        </div>
        
        
        
    </body>
</html>