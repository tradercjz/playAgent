<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" data-whc_version="26.0">
    <head><link rel="shortcut icon" href="../favicon.ico"/><link rel="icon" href="../favicon.ico"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="description" content="本节将通过两个示例展示如何实时进行因子计算。 本例中我们将以行情快照数据作为输入，针对每一笔快照实时响应，计算并输出买卖价差这一高频因子。 因子计算逻辑 行情数据中包含了买卖双方多档量价信息，买卖价差的定义为卖1价与买1价之差与均价之比： 其中 offerPrice0 、 bidPrice0 分别表示卖1价与买1价。 输入数据示例 接下来，我们将逐步在 DolphinDB ..."/><meta name="DC.rights.owner" content="(C) 版权 2025"/><meta name="copyright" content="(C) 版权 2025"/><meta name="generator" content="DITA-OT"/><meta name="DC.type" content="topic"/><meta name="DC.coverage" content=""/><meta name="DC.relation" content="../stream/str_intro.html"/><meta name="prodname" content="DolphinDB"/><meta name="brand" content="DolphinDB"/><meta name="DC.creator" content="DolphinDB"/><meta name="DC.publisher" content="DDB N/A DDB 200"/><meta name="DC.format" content="HTML5"/><meta name="DC.identifier" content="入门示例-01实时计算买卖价差"/><title>入门示例</title><!--  Generated with Oxygen version 26.0, build number 2024012323.  --><meta name="wh-path2root" content="../"/><meta name="wh-toc-id" content="入门示例-01实时计算买卖价差-d9713e4044"/><meta name="wh-source-relpath" content="stream/try_example1.dita"/><meta name="wh-out-relpath" content="stream/try_example1.html"/>

    <link rel="stylesheet" type="text/css" href="../oxygen-webhelp/app/commons.css?buildId=2024012323"/>
    <link rel="stylesheet" type="text/css" href="../oxygen-webhelp/app/topic.css?buildId=2024012323"/>

    <script src="../oxygen-webhelp/app/options/properties.js?buildId=20250305183303"></script>
    <script src="../oxygen-webhelp/app/localization/strings.js?buildId=2024012323"></script>
    <script src="../oxygen-webhelp/app/search/index/keywords.js?buildId=20250305183303"></script>
    <script defer="defer" src="../oxygen-webhelp/app/commons.js?buildId=2024012323"></script>
    <script defer="defer" src="../oxygen-webhelp/app/topic.js?buildId=2024012323"></script>
<link rel="stylesheet" type="text/css" href="../oxygen-webhelp/template/styles.css?buildId=2024012323"/><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script></head>

    <body id="入门示例-01实时计算买卖价差" class="wh_topic_page frmBody">
        <a href="#wh_topic_body" class="sr-only sr-only-focusable">
            跳转到主要内容
        </a>
        
        
        
        
        <header class="navbar navbar-default wh_header">
    <div class="container-fluid">
        <div xmlns:whc="http://www.oxygenxml.com/webhelp/components" class="wh_header_flex_container navbar-nav navbar-expand-md navbar-dark">
            <div class="wh_logo_and_publication_title_container">
                <div class="wh_logo_and_publication_title">
                    
                    <a href="https://docs.dolphindb.cn/zh/index.html" class=" wh_logo d-none d-sm-block "><img src="../logo.png" alt="  DolphinDB 文档中心  "/></a>
                    <div class=" wh_publication_title "><a href="../index.html"><span class="booktitle">  <span class="ph mainbooktitle">DolphinDB 文档中心</span>  </span></a></div>
                    
                </div>
                
                
            </div>

            <div class="wh_top_menu_and_indexterms_link collapse navbar-collapse" id="wh_top_menu_and_indexterms_link">
                
                
                
                
            </div>
        <div class=" wh_search_input navbar-form wh_topic_page_search search " role="form">
            
            
            
            <form id="searchForm" method="get" role="search" action="../search.html"><div><input type="search" placeholder="搜索 " class="wh_search_textfield" id="textToSearch" name="searchQuery" aria-label="搜索查询" required="required"/><button type="submit" class="wh_search_button" aria-label="搜索"><span class="search_input_text">搜索</span></button></div></form>
            
            <script src="/vendors/react/umd/react.production.min.js" defer="defer"></script>
<script src="/vendors/react-dom/umd/react-dom.production.min.js" defer="defer"></script>
<script src="/vendors/dayjs/dayjs.min.js" defer="defer"></script>
<script src="/vendors/antd/dist/antd.min.js" defer="defer"></script>
<script src="/vendors/@ant-design/icons/dist/index.umd.min.js" defer="defer"></script>
<script src="/zh/index.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" defer="defer"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer="defer"><!--


--></script>
<script defer="defer"><!--

// 从主页重定向
const currentUrl = window.location.href;

// 判断当前URL是否包含index.html并且路径最后部分是index.html
if (currentUrl.endsWith('index.html')) {
    // 处理根目录下的index.html跳转
    const baseUrl = currentUrl.split('/index.html')[0]; // 获取index.html之前的部分
    const redirectUrl = `${baseUrl}/about/ddb_intro.html`; // 构建跳转路径
    window.location.href = redirectUrl; // 执行跳转
}

--></script>
            
        </div></div>
    </div>
</header>
        
        
         
        
        
        
        <div class="container-fluid" id="wh_topic_container">
            <div class="row">

                <nav class="wh_tools d-print-none navbar-expand-md" aria-label="Tools">
                    
                    <div data-tooltip-position="bottom" class=" wh_breadcrumb "><ol class="d-print-none"><li><span class="home"><a href="../index.html"><span>主页</span></a></span></li><li><div class="topicref" data-id="chap7_tutorials_streaming"><div class="title"><a href="../stream/str_intro.html"><span class="keyword label">流数据</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 流数据引擎及流数据计算的基本概念</p></div></div></div></li><li class="active"><div class="topicref" data-id="入门示例-01实时计算买卖价差"><div class="title"><a href="../stream/try_example1.html">入门示例</a></div></div></li></ol></div>
                    
                    
                    
                    <div class="wh_right_tools">
                        <button class="wh_hide_highlight" aria-label="切换搜索突出显示" title="切换搜索突出显示"></button>
                        <button class="webhelp_expand_collapse_sections" data-next-state="collapsed" aria-label="折叠截面" title="折叠截面"></button>
                        
                        
                        
                        
                        <div class=" wh_print_link print d-none d-md-inline-block "><button onClick="window.print()" title="打印此页" aria-label="打印此页"></button></div>
                        
                        <button type="button" id="wh_toc_button" class="custom-toggler navbar-toggler collapsed wh_toggle_button navbar-light" aria-expanded="false" aria-label="Toggle publishing table of content" aria-controls="wh_publication_toc">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </div>
                    
                </nav>
            </div>
            
            
            
            
            <div class="wh_content_area">
                <div class="row">
                    
                        <nav id="wh_publication_toc" class="col-lg-3 col-md-3 col-sm-12 d-md-block d-none d-print-none" aria-label="Table of Contents Container">
                            <div id="wh_publication_toc_content">
		                        
                            	<div class=" wh_publication_toc " data-tooltip-position="right"><span class="expand-button-action-labels"><span id="button-expand-action" role="button" aria-label="Expand"></span><span id="button-collapse-action" role="button" aria-label="Collapse"></span><span id="button-pending-action" role="button" aria-label="Pending"></span></span><ul role="tree" aria-label="Table of Contents"><li role="treeitem"><div data-tocid="ddb_intro-d9713e87" class="topicref" data-id="ddb_intro" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../about/ddb_intro.html" id="ddb_intro-d9713e87-link">关于DolphinDB</a></div></div></li><li role="treeitem"><div data-tocid="chap1_getstarted-d9713e136" class="topicref" data-id="chap1_getstarted" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../getstarted/chap1_getstarted.html" id="chap1_getstarted-d9713e136-link">快速上手</a><div class="wh-tooltip"><p class="shortdesc">如何快速部署 DolphinDB、建库建表、写入和查询数据</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="sectionddb_deployment-d9713e189" class="topicref" data-id="sectionddb_deployment" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action sectionddb_deployment-d9713e189-link" class="wh-expand-btn"></span><div class="title"><a href="../deploy/deploy_intro.html" id="sectionddb_deployment-d9713e189-link"><span class="keyword label">部署</span></a><div class="wh-tooltip"><p class="shortdesc">如何在不同的场景中部署 DolphinDB</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="new_chap_database_manage_new_chap_dbmanage_landing_page-d9713e2259" class="topicref" data-id="new_chap_database_manage_new_chap_dbmanage_landing_page" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action new_chap_database_manage_new_chap_dbmanage_landing_page-d9713e2259-link" class="wh-expand-btn"></span><div class="title"><a href="../db_distr_comp/cfg/db_intro.html" id="new_chap_database_manage_new_chap_dbmanage_landing_page-d9713e2259-link"><span class="keyword label">数据库</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 数据库的基本概念</p></div></div></div></li><li role="treeitem" aria-expanded="true"><div data-tocid="chap7_tutorials_streaming-d9713e3760" class="topicref" data-id="chap7_tutorials_streaming" data-state="expanded"><span role="button" tabindex="0" aria-labelledby="button-collapse-action chap7_tutorials_streaming-d9713e3760-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_intro.html" id="chap7_tutorials_streaming-d9713e3760-link"><span class="keyword label">流数据</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 流数据引擎及流数据计算的基本概念</p></div></div></div><ul role="group" class="navbar-nav nav-list"><li role="treeitem" aria-expanded="false"><div data-tocid="streamfunctions-d9713e3813" class="topicref" data-id="streamfunctions" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action streamfunctions-d9713e3813-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_funcs.html" id="streamfunctions-d9713e3813-link">功能简介</a></div></div></li><li role="treeitem" class="active"><div data-tocid="入门示例-01实时计算买卖价差-d9713e4044" class="topicref" data-id="入门示例-01实时计算买卖价差" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/try_example1.html" id="入门示例-01实时计算买卖价差-d9713e4044-link">入门示例</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="内置流式计算算子-d9713e4090" class="topicref" data-id="内置流式计算算子" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action 内置流式计算算子-d9713e4090-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_operator.html" id="内置流式计算算子-d9713e4090-link"><span class="keyword label">流式计算算子</span></a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="streamingEngineTopic-d9713e4229" class="topicref" data-id="streamingEngineTopic" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action streamingEngineTopic-d9713e4229-link" class="wh-expand-btn"></span><div class="title"><a href="../funcs/themes/streamingEngine.html" id="streamingEngineTopic-d9713e4229-link"><span class="keyword label">流计算引擎</span></a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap7_tutorials_streaming-d9713e4506" class="topicref" data-id="chap7_tutorials_streaming" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap7_tutorials_streaming-d9713e4506-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_join_engine.html" id="chap7_tutorials_streaming-d9713e4506-link"><span class="keyword label">内置多数据源流式关联引擎</span></a></div></div></li><li role="treeitem"><div data-tocid="streamha-d9713e4783" class="topicref" data-id="streamha" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_ha.html" id="streamha-d9713e4783-link"><span class="keyword label">流数据高可用</span></a></div></div></li><li role="treeitem"><div data-tocid="流计算状态监控-d9713e4830" class="topicref" data-id="流计算状态监控" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_monitor.html" id="流计算状态监控-d9713e4830-link">流计算状态监控</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="replay-d9713e4876" class="topicref" data-id="replay" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action replay-d9713e4876-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_replay.html" id="replay-d9713e4876-link"><span class="keyword label">历史数据回放</span></a></div></div></li><li role="treeitem"><div data-tocid="流批一体功能-d9713e5061" class="topicref" data-id="流批一体功能" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_batch.html" id="流批一体功能-d9713e5061-link"><span class="keyword label">流批一体</span></a></div></div></li><li role="treeitem"><div data-tocid="streamengineparser-解析原理介绍-d9713e5108" class="topicref" data-id="streamengineparser-解析原理介绍" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_eng_parser.html" id="streamengineparser-解析原理介绍-d9713e5108-link">StreamEngineParser 解析原理</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="realtime_data_acces-d9713e5155" class="topicref" data-id="realtime_data_acces" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action realtime_data_acces-d9713e5155-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/realtime_data_acces.html" id="realtime_data_acces-d9713e5155-link">实时流数据接入</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="cep-d9713e5617" class="topicref" data-id="cep" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action cep-d9713e5617-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/cep.html" id="cep-d9713e5617-link">复杂事件处理（CEP）引擎</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e6123" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e6123-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/local_sub.html" id="tocId-d9713e6123-link">流处理结果交互方式</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e6312" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e6312-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_altair.html" id="tocId-d9713e6312-link">数据可视化工具</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e6405" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e6405-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_auto_sub.html" id="tocId-d9713e6405-link">金融场景应用案例</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e7097" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e7097-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/ddb_str_app_iot.html" id="tocId-d9713e7097-link">物联网场景应用案例</a></div></div></li></ul></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e7513" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e7513-link" class="wh-expand-btn"></span><div class="title"><a href="../db_distr_comp/db_oper/import_data.html" id="tocId-d9713e7513-link">数据迁移</a><div class="wh-tooltip"><p class="shortdesc">如何从不同数据源向 DolphinDB 迁移数据</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap7_tutorials_system_management-d9713e7940" class="topicref" data-id="chap7_tutorials_system_management" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap7_tutorials_system_management-d9713e7940-link" class="wh-expand-btn"></span><div class="title"><a href="../sys_man/om_intro.html" id="chap7_tutorials_system_management-d9713e7940-link"><span class="keyword label">系统运维</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 的系统运维功能及方法</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="troubleshooting-d9713e8780" class="topicref" data-id="troubleshooting" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action troubleshooting-d9713e8780-link" class="wh-expand-btn"></span><div class="title"><a href="../error_codes/troubleshooting.html" id="troubleshooting-d9713e8780-link">故障排查</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="about_language_resources-d9713e20911" class="topicref" data-id="about_language_resources" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action about_language_resources-d9713e20911-link" class="wh-expand-btn"></span><div class="title"><a href="../progr/progr_intro.html" id="about_language_resources-d9713e20911-link"><span class="keyword label">编程语言</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 编程基本概念与方法、SQL 在 DolphinDB 的应用</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="functions_references-d9713e30925" class="topicref" data-id="functions_references" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action functions_references-d9713e30925-link" class="wh-expand-btn"></span><div class="title"><a href="../funcs/funcs_intro.html" id="functions_references-d9713e30925-link"><span class="keyword label">函数参考</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 函数分类、语法、详解及示例</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="api_protocol-d9713e94064" class="topicref" data-id="api_protocol" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action api_protocol-d9713e94064-link" class="wh-expand-btn"></span><div class="title"><a href="../api/connapi_intro.html" id="api_protocol-d9713e94064-link"><span class="keyword label">连接器 &amp; API</span></a><div class="wh-tooltip"><p class="shortdesc">面向不同编程语言的 DolphinDB API 及连接器，相关协议和用法</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap6_plugin-d9713e94210" class="topicref" data-id="chap6_plugin" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap6_plugin-d9713e94210-link" class="wh-expand-btn"></span><div class="title"><a href="../plugins/plg_intro.html" id="chap6_plugin-d9713e94210-link"><span class="keyword label">插件</span></a><div class="wh-tooltip"><p class="shortdesc">多个应用场景的插件使用说明和插件开发指导</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="third_party-d9713e97904" class="topicref" data-id="third_party" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action third_party-d9713e97904-link" class="wh-expand-btn"></span><div class="title"><a href="../third_party.html" id="third_party-d9713e97904-link">第三方工具</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="about_tutorials-d9713e98227" class="topicref" data-id="about_tutorials" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action about_tutorials-d9713e98227-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/about_tutorials.html" id="about_tutorials-d9713e98227-link"><span class="keyword label">教程</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 产品使用教程</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9713e105982" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9713e105982-link" class="wh-expand-btn"></span><div class="title"><a href="../rn/server/3_00_2.html" id="tocId-d9713e105982-link">版本说明</a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 版本发布历史</p></div></div></div></li></ul></div>
		                        
                            </div>
                        </nav>
                    
                    
                    <div class="col-lg-7 col-md-9 col-sm-12" id="wh_topic_body">
                        <button id="wh_close_publication_toc_button" class="close-toc-button d-none" aria-label="Toggle publishing table of content" aria-controls="wh_publication_toc" aria-expanded="true">
                            <span class="close-toc-icon-container">
                                <span class="close-toc-icon"></span>     
                            </span>
                        </button>
                        <button id="wh_close_topic_toc_button" class="close-toc-button d-none" aria-label="Toggle topic table of content" aria-controls="wh_topic_toc" aria-expanded="true">
                            <span class="close-toc-icon-container">
                                <span class="close-toc-icon"></span>     
                            </span>
                        </button>
                        
                        <div class=" wh_topic_content body "><main role="main"><article class="- topic/topic topic" role="article" aria-labelledby="ariaid-title1">
    <h1 class="- topic/title title topictitle1" id="ariaid-title1">入门示例</h1>
    <div class="- topic/body body">
        <p class="- topic/p p">本节将通过两个示例展示如何实时进行因子计算。</p>
    </div>
    <article class="- topic/topic topic nested1" aria-labelledby="ariaid-title2" id="我们要计算什么">
        <h2 class="- topic/title title topictitle2" id="ariaid-title2">示例1：实时计算买卖价差</h2>
        <div class="- topic/body body">
            <p class="- topic/p p">本例中我们将以行情快照数据作为输入，针对每一笔快照实时响应，计算并输出买卖价差这一高频因子。</p>
            <p class="- topic/p p">
                <strong class="+ topic/ph hi-d/b ph b">因子计算逻辑</strong>
            </p>
            <p class="- topic/p p">行情数据中包含了买卖双方多档量价信息，买卖价差的定义为卖1价与买1价之差与均价之比：</p>
            <br/><img class="- topic/image image" src="images/try_example1_1.png"/><br/>
            <p class="- topic/p p">其中 offerPrice0 、 bidPrice0 分别表示卖1价与买1价。</p>
            <p class="- topic/p p">
                <strong class="+ topic/ph hi-d/b ph b">输入数据示例</strong>
            </p>
            <br/><img class="- topic/image image" src="images/try_example1_2.png"/><br/>
        </div>
        <article class="- topic/topic topic nested2" aria-labelledby="ariaid-title3" id="动手实现">
            <h3 class="- topic/title title topictitle3" id="ariaid-title3">实现步骤</h3>
            <div class="- topic/body body">
                <p class="- topic/p p">接下来，我们将逐步在 DolphinDB 上模拟行情快照数据流，并实时计算输出。完整脚本见附录。</p>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">创建作为输入的流数据表</strong></p>
                <p class="- topic/p p">首先创建一个共享流数据表 tick，用于存储和发布行情快照数据：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="动手实现__codeblock_nbq_hrg_vdc" data-ofbid="动手实现__codeblock_nbq_hrg_vdc">share(table=streamTable(<span class="hl-number">1</span>:<span class="hl-number">0</span>, `securityID`dateTime`bidPrice0`bidOrderQty0`offerPrice0`offerOrderQty0, [SYMBOL,TIMESTAMP,DOUBLE,LONG,DOUBLE,LONG]), sharedName=`tick)</pre>
                <p class="- topic/p p">执行上述语句后，DolphinDB 数据节点的内存中将创建一个名为 tick 的表，但目前尚未写入任何数据。</p>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">创建作为输出的流数据表</strong></p>
                <p class="- topic/p p">创建一个共享流数据表 resultTable，用于存储和发布因子计算结果：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="动手实现__codeblock_obq_hrg_vdc" data-ofbid="动手实现__codeblock_obq_hrg_vdc">share(table=streamTable(<span class="hl-number">10000</span>:<span class="hl-number">0</span>, [<span class="hl-string">"securityID"</span>, <span class="hl-string">"dateTime"</span>, <span class="hl-string">"factor"</span>], [SYMBOL, TIMESTAMP, DOUBLE]), sharedName=`resultTable)</pre>
                <p class="- topic/p p">执行以上语句后，DolphinDB 数据节点的内存中将创建一个名为 resultTable
                    的表，但目前尚未写入任何数据。我们希望将后续的计算结果实时写入该表中。</p>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">定义计算逻辑</strong></p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="动手实现__codeblock_pbq_hrg_vdc" data-ofbid="动手实现__codeblock_pbq_hrg_vdc"><strong class="hl-keyword">def</strong> factorCalFunc(msg){
	tmp = select securityID, dateTime, (offerPrice0-bidPrice0)*<span class="hl-number">2</span>\(offerPrice0+bidPrice0) <strong class="hl-keyword">as</strong> factor <strong class="hl-keyword">from</strong> msg
	objByName(<span class="hl-string">"resultTable"</span>).append!(tmp)	
}</pre>
                <ul class="- topic/ul ul" id="动手实现__ul_qbq_hrg_vdc" data-ofbid="动手实现__ul_qbq_hrg_vdc">
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">msg</em> 可以看做一个与 tick 表结构相同的内存表。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><code class="+ topic/ph pr-d/codeph ph codeph">objByName("resultTable").append!(tmp)</code> 表示向结果表 resultTable
                            插入 tmp 表。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">tmp 表通过 DolphinDB SQL
                            语句计算得出，(offerPrice0-bidPrice0)*2\(offerPrice0+bidPrice0) 表示买卖价差公式，对 msg
                            表中的每一行记录都会计算出对应的买卖价差因子。</p>
                    </li>
                </ul>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">订阅流数据表</strong></p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="动手实现__codeblock_vpt_112_vdc" data-ofbid="动手实现__codeblock_vpt_112_vdc">subscribeTable(tableName=<span class="hl-string">"tick"</span>, actionName=<span class="hl-string">"factorCal"</span>, offset=-<span class="hl-number">1</span>, handler=factorCalFunc, msgAsTable=true, batchSize=<span class="hl-number">1</span>, throttle=<span class="hl-number">0.001</span>)</pre>
                <p class="- topic/p p">订阅流数据表 tick，并指定 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 作为数据处理方法，同时分配一个后台线程不断处理订阅到的新数据。每当表
                    tick 插入一批数据时，这些数据都会被发布到订阅端，后台线程会接收新增数据，并以此作为输入调用函数
                        <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code>。</p>
                <ul class="- topic/ul ul" id="动手实现__ul_frc_1c2_vdc" data-ofbid="动手实现__ul_frc_1c2_vdc">
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">tableName</em>="tick" 表示订阅流数据表 tick。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">actionName</em>="factorCal" 表示订阅任务的名称，用户自定义。相同节点上， <em class="+ topic/ph hi-d/i ph i">tableName</em> 和
                                <em class="+ topic/ph hi-d/i ph i">actionName</em> 的组合必须唯一。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">offset</em>=-1 表示从订阅之后表 tick 中新增的第一条数据开始消费。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">handler</em>=factorCalFunc 表示对订阅数据的处理方式。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">msgAsTable</em>=true 表示待处理的订阅到的数据是表，即 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code>
                            函数的入参 <em class="+ topic/ph hi-d/i ph i">msg</em> 是表。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">batchSize</em>=1 和 <em class="+ topic/ph hi-d/i ph i">throttle</em>=0.001
                            共同指定了后台线程的处理频率。本例中任意有一条或多条待处理数据会触发一次 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code>
                            的调用。</p>
                    </li>
                </ul>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">模拟数据输入</strong></p>
                <p class="- topic/p p">执行上述所有脚本后，我们提交了对流数据表 tick 的订阅，并指定调用自定义函数 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code>
                    来处理收到的订阅数据。接下来，我们将向流数据表中注入一些数据，以观察订阅消费的结果。</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="动手实现__codeblock_rbq_hrg_vdc" data-ofbid="动手实现__codeblock_rbq_hrg_vdc">insert into tick values(`<span class="hl-number">000001</span>, <span class="hl-number">2023.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">30</span>:<span class="hl-number">00.000</span>, <span class="hl-number">19.98</span>, <span class="hl-number">100</span>, <span class="hl-number">19.99</span>, <span class="hl-number">120</span>)
insert into tick values(`<span class="hl-number">000001</span>, <span class="hl-number">2023.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">30</span>:<span class="hl-number">03.000</span>, <span class="hl-number">19.96</span>, <span class="hl-number">130</span>, <span class="hl-number">19.99</span>, <span class="hl-number">120</span>)
insert into tick values(`<span class="hl-number">000001</span>, <span class="hl-number">2023.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">30</span>:<span class="hl-number">06.000</span>, <span class="hl-number">19.90</span>, <span class="hl-number">120</span>, <span class="hl-number">20.00</span>, <span class="hl-number">130</span>)</pre>
                <p class="- topic/p p">在向表 tick 插入若干条数据后，查看结果表 <em class="+ topic/ph hi-d/i ph i">resultTable</em>：</p>
                <br/><img class="- topic/image image" id="动手实现__image_sbq_hrg_vdc" src="images/try_example1_3.png"/><br/>
                <p class="- topic/p p">至此，我们通过发布订阅框架和流计算引擎完成了一个流计算任务的开发。不断向流数据表 tick 中插入数据将持续触发计算，并将因子输出到结果表。</p>
                <p class="- topic/p p">如有需要，可参考管理流计算任务，对该计算任务进行监控或环境清理。</p>
            </div>
        </article>
    </article>
    <article class="- topic/topic topic nested1" aria-labelledby="ariaid-title4" id="topic_cjv_brg_vdc">
        <h2 class="- topic/title title topictitle2" id="ariaid-title4">示例2：实时计算过去 5 分钟主动成交量占比</h2>
        <div class="- topic/body body">
            <p class="- topic/p p">在本例中，我们将使用逐笔成交数据作为输入，对每笔数据进行实时响应，计算并输出过去5分钟的主动成交量占比这一高频因子。</p>
            <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">因子计算逻辑</strong>
            </p>
            <p class="- topic/p p">主动成交占比即主动成交量占总成交量的比例，其计算公式如下：</p>
            <br/><img class="- topic/image image" id="topic_cjv_brg_vdc__image_ox2_grg_vdc" src="images/try_example2_1.png" height="171" width="394"/><br/>
            <p class="- topic/p p">其中：</p>
            <ul class="- topic/ul ul" id="topic_cjv_brg_vdc__ul_n4g_ftg_vdc" data-ofbid="topic_cjv_brg_vdc__ul_n4g_ftg_vdc">
                <li class="- topic/li li">
                    <div class="- topic/p p">actVolumes<sub class="+ topic/ph hi-d/sub ph sub">t</sub> 表示 t-window 时刻到 t 时刻区间内的主动成交量；指示函数
                            I<sub class="+ topic/ph hi-d/sub ph sub">buyNo&gt;selNo</sub> 的含义如下：<br/><img class="- topic/image image" id="topic_cjv_brg_vdc__image_px2_grg_vdc" src="images/try_example2_2.png" height="48" width="296"/><br/></div>
                </li>
                <li class="- topic/li li">
                    <p class="- topic/p p">totalVolume<sub class="+ topic/ph hi-d/sub ph sub">t</sub> 表示 t-window 时刻到 t 时刻区间的总成交量。</p>
                </li>
            </ul>
            <p class="- topic/p p">
                <strong class="+ topic/ph hi-d/b ph b">输入数据示例</strong>
            </p>
            <br/><img class="- topic/image image" id="topic_cjv_brg_vdc__image_qx2_grg_vdc" src="images/try_example2_3.png"/><br/>
        </div>
        <article class="- topic/topic topic nested2" aria-labelledby="ariaid-title5" id="topic_yx4_4rg_vdc">
            <h3 class="- topic/title title topictitle3" id="ariaid-title5">实现步骤</h3>
            <div class="- topic/body body">
                <p class="- topic/p p">接下来，我们将逐步在 DolphinDB 上模拟逐笔成交数据流，并实时计算输出。完整脚本见附录。</p>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">创建作为输入的流数据表</strong></p>
                <p class="- topic/p p">首先创建一个共享流数据表 trade ，用于存储和发布逐笔成交数据：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="topic_yx4_4rg_vdc__codeblock_ufh_srg_vdc" data-ofbid="topic_yx4_4rg_vdc__codeblock_ufh_srg_vdc"><code>share(table=streamTable(1:0, `securityID`tradeTime`tradePrice`tradeQty`tradeAmount`buyNo`sellNo, [SYMBOL,TIMESTAMP,DOUBLE,INT,DOUBLE,LONG,LONG]), sharedName=`trade)</code></pre>
                <p class="- topic/p p">执行以上语句后，DolphinDB 数据节点的内存中将创建一个名为 trade 的表，但目前尚未写入任何数据。</p>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">创建作为输出的流数据表</strong></p>
                <p class="- topic/p p">创建一个共享流数据表 resultTable，用于存储和发布因子计算结果：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="topic_yx4_4rg_vdc__codeblock_t4k_5rg_vdc" data-ofbid="topic_yx4_4rg_vdc__codeblock_t4k_5rg_vdc"><code>share(table=streamTable(10000:0, ["securityID", "tradeTime", "factor"], [SYMBOL, TIMESTAMP, DOUBLE]), sharedName=`resultTable) </code></pre>
                <p class="- topic/p p">执行以上语句后，DolphinDB 数据节点的内存中将创建一个名为 resultTable
                    的表，但目前尚未写入任何数据。我们希望将后续的计算结果实时写入该表中。</p>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">定义计算逻辑</strong></p>
                <p class="- topic/p p">示例 1
                    中的因子计算不涉及状态，因此实现逻辑相对简单。而本示例的主动成交量因子计算依赖于历史记录，因此其计算逻辑需要考虑如何获取状态。本节将首先介绍一种错误的实现方式，以帮助用户理解带状态因子计算的处理方法，接着给出了正确的实现逻辑。</p>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">定义错误的计算函数</strong></p>
                <p class="- topic/p p">首先，我们定义一个 factorVolumeCalFunc 函数：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="topic_yx4_4rg_vdc__codeblock_ygm_wrg_vdc" data-ofbid="topic_yx4_4rg_vdc__codeblock_ygm_wrg_vdc"><code>def factorVolumeCalFunc (msg){
	tmp = select securityID, tradeTime, tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, 0), 5m)\tmsum(tradeTime, tradeQty, 5m) as factor from msg context by securityID
	objByName("resultTable").append!(tmp)
}
subscribeTable(tableName="trade", actionName="factorCal", offset=-1, handler=factorVolumeCalFunc , msgAsTable=true, batchSize=1, throttle=0.001)</code></pre>
                <ul class="- topic/ul ul" id="topic_yx4_4rg_vdc__ul_zgm_wrg_vdc" data-ofbid="topic_yx4_4rg_vdc__ul_zgm_wrg_vdc">
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">msg</em> 可以看做一个与 trade 表结构相同的内存表</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">objByName("resultTable").append!(tmp) 表示往结果表 resultTable 插入 tmp 表</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">tmp 表通过 DolphinDB SQL 语句计算得到：</p>
                        <ul class="- topic/ul ul" id="topic_yx4_4rg_vdc__ul_ahm_wrg_vdc" data-ofbid="topic_yx4_4rg_vdc__ul_ahm_wrg_vdc">
                            <li class="- topic/li li">
                                <p class="- topic/p p">SQL 语句中使用 context by 对表 msg 分组后，返回的结果表 tmp 的行数与 msg 一致。context by
                                    和时间序列函数（如此处的 tmsum）一起使用，可实现在分组内（ securityID
                                    ）按记录的顺序逐行进行滑动时间窗口聚合计算。</p>
                            </li>
                            <li class="- topic/li li">
                                <p class="- topic/p p">tmsum(tradeTime, tradeQty, 5m) 表示以 tradeTime 为时间列，对每一行划定过去 5
                                    分钟的窗口，对窗口内所有记录的 tradeQty 求和，即过去五分钟的总成交量。</p>
                            </li>
                            <li class="- topic/li li">
                                <p class="- topic/p p">tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, 0), 5m) 表示以
                                    tradeTime 为时间列，对每一行划定过去 5 分钟窗口，对窗口内 buyNo&gt;sellNo 的这部分记录的
                                    tradeQty 求和，即过去五分钟的主动成交量。</p>
                            </li>
                        </ul>
                    </li>
                </ul>
                <p class="- topic/p p">当该函数被用于处理订阅数据时，每次仅基于 trade
                    表新增的记录进行计算，而未能缓存或获取主动成交量因子依赖的历史记录。这会导致错误结果错误。下面进一步展示函数计算的过程及结果。</p>
                <p class="- topic/p p">首先构造一批数据调用一次 factorVolumeCalFunc 函数。</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="topic_yx4_4rg_vdc__codeblock_chm_wrg_vdc" data-ofbid="topic_yx4_4rg_vdc__codeblock_chm_wrg_vdc"><code>// 定义结果表
share(table=streamTable(10000:0, ["securityID", "tradeTime", "factor"], [SYMBOL, TIMESTAMP, DOUBLE]), sharedName=`resultTable)
// 构造输入数据
input1 = table(1:0, `securityID`tradeTime`tradePrice`tradeQty`tradeAmount`buyNo`sellNo, [SYMBOL,TIMESTAMP,DOUBLE,INT,DOUBLE,LONG,LONG])
insert into input1 values(`000155, 2020.01.01T09:30:00.000, 30.85, 100, 3085, 4951, 0)
insert into input1 values(`000155, 2020.01.01T09:31:00.000, 30.86, 100, 3086, 4952, 1)
insert into input1 values(`000155, 2020.01.01T09:32:00.000, 30.85, 200, 6170, 5001, 5100)
insert into input1 values(`000155, 2020.01.01T09:33:00.000, 30.83, 100, 3083, 5202, 5204)
insert into input1 values(`000155, 2020.01.01T09:34:00.000, 30.82, 300, 9246, 5506, 5300)
insert into input1 values(`000155, 2020.01.01T09:35:00.000, 30.82, 500, 15410, 5510, 5600)
insert into input1 values(`000155, 2020.01.01T09:36:00.000, 30.87, 800, 24696, 5700, 5600)
// 调用一次 factorVolumeCalFunc  函数
factorVolumeCalFunc (msg=input1)</code></pre>
                <p class="- topic/p p">执行下述语句查询结果表：</p>
                <pre class="- topic/pre pre" id="topic_yx4_4rg_vdc__pre_dhm_wrg_vdc" data-ofbid="topic_yx4_4rg_vdc__pre_dhm_wrg_vdc"><code class="+ topic/ph pr-d/codeph ph codeph">select * from resultTable</code></pre>
                <p class="- topic/p p">返回结果如下，目前结果正确：</p>
                <br/><img class="- topic/image image" id="topic_yx4_4rg_vdc__image_ejp_yrg_vdc" src="images/try_example2_4.png"/><br/>
                <p class="- topic/p p">再构造1条数据，并调用一次 factorVolumeCalFunc 函数：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="topic_yx4_4rg_vdc__codeblock_f5c_zrg_vdc" data-ofbid="topic_yx4_4rg_vdc__codeblock_f5c_zrg_vdc"><code>// 构造输入数据
input2 = table(1:0, `securityID`tradeTime`tradePrice`tradeQty`tradeAmount`buyNo`sellNo, [SYMBOL,TIMESTAMP,DOUBLE,INT,DOUBLE,LONG,LONG])
insert into input2 values(`000155, 2020.01.01T09:36:00.000, 30.87, 800, 24696, 5700, 5600)
// 再调用一次 factorVolumeCalFunc  函数
factorVolumeCalFunc (msg=input2)</code></pre>
                <p class="- topic/p p">结果表如下，最后一行对应新增的 input2 的结果，factor 值明显错误：</p>
                <br/><img class="- topic/image image" id="topic_yx4_4rg_vdc__image_qhq_zrg_vdc" src="images/try_example2_5.png"/><br/>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">定义正确的计算函数</strong></p>
                <p class="- topic/p p">为了实现正确的计算逻辑，我们需要在上文的 factorVolumeCalFunc 函数基础上进行复杂的改写，以获取历史数据。然而，DolphinDB
                    提供了一种更简便的实现方式——DolphinDB
                        计算引擎。流计算引擎可以被视为一个封装的独立计算黑盒，其内部会缓存所需的历史数据或中间结果（即状态），通过向其写入数据触发计算，并将结果输出到目标表。有关流计算引擎的详细介绍，<a class="- topic/xref xref" href="../funcs/themes/streamingEngine.html">内置流计算引擎</a> 。</p>
                <p class="- topic/p p">针对不同场景，DolphinDB 提供了多种流计算引擎。在本例中，由于需要逐条分组响应计算并输出，因此应选择响应式状态引擎。</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="topic_yx4_4rg_vdc__codeblock_ejr_1sg_vdc" data-ofbid="topic_yx4_4rg_vdc__codeblock_ejr_1sg_vdc"><code>createReactiveStateEngine(name="reactiveDemo", metrics=&lt;[tradeTime, tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, 0), 5m)\tmsum(tradeTime, tradeQty, 5m)]&gt;, dummyTable=trade, outputTable=resultTable, keyColumn="securityID")
def factorVolumeCalFunc (msg){
    getStreamEngine("reactiveDemo").append!(msg)
}</code></pre>
                <p class="- topic/p p">以上代码使用 createReactiveStateEngine 函数定义一个响应式状态引擎：</p>
                <ul class="- topic/ul ul" id="topic_yx4_4rg_vdc__ul_fjr_1sg_vdc" data-ofbid="topic_yx4_4rg_vdc__ul_fjr_1sg_vdc">
                    <li class="- topic/li li">
                        <p class="- topic/p p">引擎需要一个在节点上唯一的名字，此处为 reactiveDemo。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">dummyTable</em>=trade 表示引擎的输入表结构与表 trade 一致。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">outputTable</em>=resultTable 表示计算结果输出到结果表 resultTable。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">keyColumn</em>="securityID" 表示按 securityID 进行分组计算。分组列将作为引擎输出表的第一列。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">metrics</em> 定义了因子计算的逻辑。其中的 tradeTime 表示将输入的 tradeTime
                            列随计算结果一同输出，tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, 0),
                            5m)\tmsum(tradeTime, tradeQty, 5m) 计算得到的主动成交量占比作为计算结果列输出。</p>
                    </li>
                </ul>
                <p class="- topic/p p">在此定义的 factorVolumeCalFunc 函数中，tmsum 在响应式状态引擎中的含义与上文 SQL
                    语句中的业务含义一致，但其内部实现有所不同。在引擎中，tmsum 是基于上一条计算结果进行增量计算的，因此引擎会缓存必要的计算状态。例如，对于输入记录
                    09:36:00.000，其过去 5 分钟的总成交量计算公式为：该记录之前的最后一条记录过去 5 分钟总成交量 + 该记录的成交量 - 上一条记录的过去 5
                    分钟窗口内不属于当前记录时间窗口的记录对应的成交量。</p>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">订阅流数据表</strong></p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="topic_yx4_4rg_vdc__codeblock_yml_fsg_vdc" data-ofbid="topic_yx4_4rg_vdc__codeblock_yml_fsg_vdc"><code>subscribeTable(tableName="trade", actionName="factorCal", offset=-1, handler=factorVolumeCalFunc, msgAsTable=true, batchSize=1, throttle=0.001)</code></pre>
                <p class="- topic/p p">subscribeTable 函数的 <em class="+ topic/ph hi-d/i ph i">handler</em>
                    参数除了指定为一元函数外，还可以直接指定为数据表。getStreamEngine("reactiveDemo") 返回的流计算引擎句柄是一个数据表，因此可以将
                        <em class="+ topic/ph hi-d/i ph i">handler</em> 直接指定为引擎句柄，而无需额外定义 factorVolumeCalFunc 函数，从而简化上述脚本。</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="topic_yx4_4rg_vdc__codeblock_phm_dsg_vdc" data-ofbid="topic_yx4_4rg_vdc__codeblock_phm_dsg_vdc"><code>createReactiveStateEngine(name="reactiveDemo", metrics=&lt;[tradeTime, tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, 0), 5m)\tmsum(tradeTime, tradeQty, 5m)]&gt;, dummyTable=trade, outputTable=resultTable, keyColumn="securityID")
subscribeTable(tableName="trade", actionName="factorCal", offset=-1, handler=getStreamEngine("reactiveDemo"), msgAsTable=true, batchSize=1, throttle=0.001)</code></pre>
                <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">模拟数据输入</strong></p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="topic_yx4_4rg_vdc__codeblock_shm_dsg_vdc" data-ofbid="topic_yx4_4rg_vdc__codeblock_shm_dsg_vdc"><code>insert into trade values(`000155, 2020.01.01T09:30:00.000, 30.85, 100, 3085, 4951, 0)
insert into trade values(`000155, 2020.01.01T09:31:00.000, 30.86, 100, 3086, 4952, 1)
insert into trade values(`000155, 2020.01.01T09:32:00.000, 30.85, 200, 6170, 5001, 5100)
insert into trade values(`000155, 2020.01.01T09:33:00.000, 30.83, 100, 3083, 5202, 5204)
insert into trade values(`000155, 2020.01.01T09:34:00.000, 30.82, 300, 9246, 5506, 5300)
insert into trade values(`000155, 2020.01.01T09:35:00.000, 30.82, 500, 15410, 5510, 5600)</code></pre>
                <p class="- topic/p p">插入若干条数据到表 trade 后，查看结果表 resultTable：</p>
                <br/><img class="- topic/image image" id="topic_yx4_4rg_vdc__image_pdx_3sg_vdc" src="images/try_example2_6.png"/><br/>
                <p class="- topic/p p">以上结果符合预期。我们再插入一条数据：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="topic_yx4_4rg_vdc__codeblock_gns_jsg_vdc" data-ofbid="topic_yx4_4rg_vdc__codeblock_gns_jsg_vdc"><code>insert into trade values(`000155, 2020.01.01T09:36:00.000, 30.87, 800, 24696, 5700, 5600)</code></pre>
                <p class="- topic/p p">结果表对应地新增了一条记录，且对于09:36:00这条记录，计算得到了正确的 factor 值：</p>
                <br/><img class="- topic/image image" id="topic_yx4_4rg_vdc__image_jzw_ksg_vdc" src="images/try_example2_7.png"/><br/>
            </div>
        </article>
    </article>
    <article class="- topic/topic topic nested1" aria-labelledby="ariaid-title6" id="进行运维">
        <h2 class="- topic/title title topictitle2" id="ariaid-title6">管理流计算任务</h2>
        <div class="- topic/body body">
            <p class="- topic/p p">系统提供了运维函数，用于查看流计算的执行情况。除了通过函数查询外，在 2.00.11 及以上版本中，用户还可以在 Web 界面的流计算监控模块中直接查看。</p>
            <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">查看流订阅消费的状态</strong></p>
            <p class="- topic/p p">调用 <code class="+ topic/ph pr-d/codeph ph codeph">getStreamingStat</code> 函数，可以查看订阅状态。</p>
            <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="进行运维__codeblock_jj2_qh2_vdc" data-ofbid="进行运维__codeblock_jj2_qh2_vdc"><code>getStreamingStat().subWorkers</code></pre>
            <p class="- topic/p p">执行代码后，可以观察到节点上有一个订阅线程在工作。该订阅已经处理了 7 条消息，目前没有报错。订阅消费队列的最大深度为1000万，目前队列里没有待处理的数据。</p>
            <figure class="- topic/fig fig fignone" id="进行运维__fig_d4k_s22_vdc" data-ofbid="进行运维__fig_d4k_s22_vdc">
                <br/><img class="- topic/image image" id="进行运维__image_yzg_fdm_xzb" src="images/try_example2_8.png"/><br/>
            </figure>
            <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">查看流计算引擎状态</strong></p>
            <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="进行运维__codeblock_vfm_35g_vdc" data-ofbid="进行运维__codeblock_vfm_35g_vdc"><code>getStreamEngineStat().ReactiveStreamEngine</code></pre>
            <p class="- topic/p p">执行以上代码后可以看到，目前插入引擎的输入数据中，只有一个分组（即000155），共输入了 7 条数据，引擎内部维护的状态占用了1836字节。</p>
            <br/><img class="- topic/image image" id="进行运维__image_ulq_fdm_xzb" src="images/try_example2_9%E3%80%81.png"/><br/>
            <p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">清理流计算环境</strong></p>
            <p class="- topic/p p">当流计算任务运行一段时间后，或许我们需要下线计算任务、更改计算逻辑或者修改输入源的表结构，那么我们可能需要将订阅、引擎或者流数据表分别取消掉，可以使用以下系统函数。</p>
            <ul class="- topic/ul ul" id="进行运维__ul_p1k_sh2_vdc" data-ofbid="进行运维__ul_p1k_sh2_vdc">
                <li class="- topic/li li">
                    <p class="- topic/p p">取消订阅：</p>
                    <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="进行运维__codeblock_tbj_th2_vdc" data-ofbid="进行运维__codeblock_tbj_th2_vdc"><code>unsubscribeTable(tableName="trade", actionName="factorCal")</code></pre>
                    <p class="- topic/p p">执行以上代码可以取消特定的订阅关系，之后表 trade 再发布数据，系统也不会计算主动成交量因子。</p>
                </li>
                <li class="- topic/li li"><p class="- topic/p p">释放流计算引擎：</p><pre class="+ topic/pre pr-d/codeblock pre codeblock" id="进行运维__codeblock_k3j_f5g_vdc" data-ofbid="进行运维__codeblock_k3j_f5g_vdc"><code>dropStreamEngine(`reactiveDemo)</code></pre>执行以上脚本可以释放流计算引擎
                        <code class="+ topic/ph pr-d/codeph ph codeph">reactiveDemo</code> ，引擎占用的内存也会一起释放。</li>
                <li class="- topic/li li">
                    <p class="- topic/p p">删除流数据表：</p>
                    <pre class="+ topic/pre pr-d/codeblock pre codeblock" id="进行运维__codeblock_pny_5h2_vdc" data-ofbid="进行运维__codeblock_pny_5h2_vdc"><code>dropStreamTable(`trade)</code></pre>
                </li>
            </ul>
        </div>
    </article>
    <article class="- topic/topic topic nested1" aria-labelledby="ariaid-title7" id="附录">
        <h2 class="- topic/title title topictitle2" id="ariaid-title7">附录</h2>
        <div class="- topic/body body">
            <p class="- topic/p p">
                <strong class="+ topic/ph hi-d/b ph b">示例 1 完整脚本</strong>
            </p>
            <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">// 创建作为输入的流数据表
share(table=streamTable(<span class="hl-number">1</span>:<span class="hl-number">0</span>, `securityID`dateTime`bidPrice0`bidOrderQty0`offerPrice0`offerOrderQty0, [SYMBOL,TIMESTAMP,DOUBLE,LONG,DOUBLE,LONG]), sharedName=`tick)
// 创建作为输出的流数据表
share(table=streamTable(<span class="hl-number">10000</span>:<span class="hl-number">0</span>, [<span class="hl-string">"securityID"</span>, <span class="hl-string">"dateTime"</span>, <span class="hl-string">"factor"</span>], [SYMBOL, TIMESTAMP, DOUBLE]), sharedName=`resultTable)
go
// 定义处理函数
<strong class="hl-keyword">def</strong> factorCalFunc(msg){
	tmp = select securityID, dateTime, (offerPrice0-bidPrice0)*<span class="hl-number">2</span>\(offerPrice0+bidPrice0) <strong class="hl-keyword">as</strong> factor <strong class="hl-keyword">from</strong> msg
	objByName(<span class="hl-string">"resultTable"</span>).append!(tmp)	
}
// 订阅流数据表
subscribeTable(tableName=<span class="hl-string">"tick"</span>, actionName=<span class="hl-string">"factorCal"</span>, offset=-<span class="hl-number">1</span>, handler=factorCalFunc, msgAsTable=true, batchSize=<span class="hl-number">1</span>, throttle=<span class="hl-number">0.001</span>)
go
// 模拟数据输入
insert into tick values(`<span class="hl-number">000001</span>, <span class="hl-number">2023.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">30</span>:<span class="hl-number">00.000</span>, <span class="hl-number">19.98</span>, <span class="hl-number">100</span>, <span class="hl-number">19.99</span>, <span class="hl-number">120</span>)
insert into tick values(`<span class="hl-number">000001</span>, <span class="hl-number">2023.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">30</span>:<span class="hl-number">03.000</span>, <span class="hl-number">19.96</span>, <span class="hl-number">130</span>, <span class="hl-number">19.99</span>, <span class="hl-number">120</span>)
insert into tick values(`<span class="hl-number">000001</span>, <span class="hl-number">2023.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">30</span>:<span class="hl-number">06.000</span>, <span class="hl-number">19.90</span>, <span class="hl-number">120</span>, <span class="hl-number">20.00</span>, <span class="hl-number">130</span>)</pre>
            <p class="- topic/p p">
                <strong class="+ topic/ph hi-d/b ph b">示例 2 完整脚本</strong>
            </p>
            <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="附录__codeblock_ynh_qsg_vdc" data-ofbid="附录__codeblock_ynh_qsg_vdc">// 创建作为输入的流数据表
share(table=streamTable(<span class="hl-number">1</span>:<span class="hl-number">0</span>, `securityID`tradeTime`tradePrice`tradeQty`tradeAmount`buyNo`sellNo, [SYMBOL,TIMESTAMP,DOUBLE,INT,DOUBLE,LONG,LONG]), sharedName=`trade)
// 创建作为输出的流数据表
share(table=streamTable(<span class="hl-number">10000</span>:<span class="hl-number">0</span>, [<span class="hl-string">"securityID"</span>, <span class="hl-string">"tradeTime"</span>, <span class="hl-string">"factor"</span>], [SYMBOL, TIMESTAMP, DOUBLE]), sharedName=`resultTable)

go

// 定义处理函数
createReactiveStateEngine(name=<span class="hl-string">"reactiveDemo"</span>, metrics=&lt;[tradeTime, tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, <span class="hl-number">0</span>), <span class="hl-number">5</span>m)\tmsum(tradeTime, tradeQty, <span class="hl-number">5</span>m)]&gt;, dummyTable=trade, outputTable=resultTable, keyColumn=<span class="hl-string">"securityID"</span>)
// 订阅流数据表
subscribeTable(tableName=<span class="hl-string">"trade"</span>, actionName=<span class="hl-string">"factorCal"</span>, offset=-<span class="hl-number">1</span>, handler=getStreamEngine(<span class="hl-string">"reactiveDemo"</span>), msgAsTable=true, batchSize=<span class="hl-number">1</span>, throttle=<span class="hl-number">0.001</span>)

go

insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">30</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.85</span>, <span class="hl-number">100</span>, <span class="hl-number">3085</span>, <span class="hl-number">4951</span>, <span class="hl-number">0</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">31</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.86</span>, <span class="hl-number">100</span>, <span class="hl-number">3086</span>, <span class="hl-number">4952</span>, <span class="hl-number">1</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">32</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.85</span>, <span class="hl-number">200</span>, <span class="hl-number">6170</span>, <span class="hl-number">5001</span>, <span class="hl-number">5100</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">33</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.83</span>, <span class="hl-number">100</span>, <span class="hl-number">3083</span>, <span class="hl-number">5202</span>, <span class="hl-number">5204</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">34</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.82</span>, <span class="hl-number">300</span>, <span class="hl-number">9246</span>, <span class="hl-number">5506</span>, <span class="hl-number">5300</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">35</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.82</span>, <span class="hl-number">500</span>, <span class="hl-number">15410</span>, <span class="hl-number">5510</span>, <span class="hl-number">5600</span>)

insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">36</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.87</span>, <span class="hl-number">800</span>, <span class="hl-number">24696</span>, <span class="hl-number">5700</span>, <span class="hl-number">5600</span>)</pre>
        </div>
    </article>
</article></main></div>
                        
                        
                        
                        
                        
                        
                    </div>
                    
                        <nav role="navigation" id="wh_topic_toc" aria-label="On this page" class="col-lg-2 d-none d-lg-block navbar d-print-none"> 
                            <div id="wh_topic_toc_content">
		                        
	                            <div class=" wh_topic_toc "><div class="wh_topic_label">在本页上</div><ul><li class="topic-item"><a href="#%E6%88%91%E4%BB%AC%E8%A6%81%E8%AE%A1%E7%AE%97%E4%BB%80%E4%B9%88" data-tocid="我们要计算什么">示例1：实时计算买卖价差</a><ul><li class="topic-item"><a href="#%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0" data-tocid="动手实现">实现步骤</a></li></ul></li><li class="topic-item"><a href="#topic_cjv_brg_vdc" data-tocid="topic_cjv_brg_vdc">示例2：实时计算过去 5 分钟主动成交量占比</a><ul><li class="topic-item"><a href="#topic_yx4_4rg_vdc" data-tocid="topic_yx4_4rg_vdc">实现步骤</a></li></ul></li><li class="topic-item"><a href="#%E8%BF%9B%E8%A1%8C%E8%BF%90%E7%BB%B4" data-tocid="进行运维">管理流计算任务</a></li><li class="topic-item"><a href="#%E9%99%84%E5%BD%95" data-tocid="附录">附录</a></li></ul></div>
	                        	
                        	</div>
                        </nav>
                    
                </div>
            </div>
            
            
            
        </div> 
        <footer class="navbar navbar-default wh_footer">
  <div class=" footer-container mx-auto ">
<title>Copyright</title><p><b> ©2025 浙江智臾科技有限公司 浙ICP备18048711号-3</b></p>
  </div>
</footer>
        
        <div id="go2top" class="d-print-none">
            <span class="oxy-icon oxy-icon-up"></span>
        </div>
        
        <div id="modal_img_large" class="modal">
            <span class="close oxy-icon oxy-icon-remove"></span>
            <div id="modal_img_container"></div>
            <div id="caption"></div>
        </div>
        
        
        
    </body>
</html>